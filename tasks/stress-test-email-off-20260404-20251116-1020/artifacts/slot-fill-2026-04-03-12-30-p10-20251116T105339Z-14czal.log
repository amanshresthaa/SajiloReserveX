
> ship-fast-code@0.1.0 booking:flow /Users/amankumarshrestha/Downloads/SajiloReserveX
> tsx -r tsconfig-paths/register scripts/run-booking-flow.ts --restaurant-slug white-horse-pub-waterbeach --date 2026-04-03 --time 12\:30 --party-size 10 --stress --stress-max 6 --timeout-ms 180000 --base-url http\://localhost\:3000 --pretty

[dotenv@17.2.2] injecting env (0) from .env.local -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
[dotenv@17.2.2] injecting env (0) from .env.development -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
[dotenv@17.2.2] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
[2025-11-16T10:53:40.727Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"a572c783-cc83-4bda-8002-5458d989c008","bookingId":null,"iteration":1,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:53:40.727Z] [INFO] [submit] Submitting booking request {"correlationId":"a572c783-cc83-4bda-8002-5458d989c008","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:30","party":10,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[supabase] strict hold enforcement active
[2025-11-16T10:53:49.457Z] [INFO] [submit] Booking created {"correlationId":"a572c783-cc83-4bda-8002-5458d989c008","bookingId":"622431d3-59ed-4585-8455-4e850d8c83d7","duplicate":false,"initialStatus":"confirmed","durationMs":8729,"maskedEmail":"bo***3@example.com","maskedPhone":"********2783"}
[2025-11-16T10:53:49.770Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"a572c783-cc83-4bda-8002-5458d989c008","bookingId":"622431d3-59ed-4585-8455-4e850d8c83d7","reference":"78HWQCZXAC","bookingDate":"2026-04-03","startTime":"12:30:00","endTime":"14:00:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:53:48.935Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":3081,"attemptId":"4ab9e419-fdab-482b-842e-574b328608a4","emailSent":false,"emailVariant":"standard"},"iteration":1,"submitDurationMs":8729,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":9043,"tablesAssigned":1,"totalCapacity":10,"seatWaste":0,"tableNumbers":["MD-11"],"partySize":10,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"32f527ff-66c7-4d1d-b2a9-914ea6125239","tableId":"fadc94ba-86ed-4075-a59d-5c84db03d150","tableNumber":"MD-11","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":10,"startAt":null,"endAt":null}]}
[2025-11-16T10:53:49.771Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"b0cfbf1f-8ad2-4531-8e57-0afae9d0d566","bookingId":null,"iteration":2,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:53:49.771Z] [INFO] [submit] Submitting booking request {"correlationId":"b0cfbf1f-8ad2-4531-8e57-0afae9d0d566","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:30","party":10,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:53:59.116Z] [INFO] [submit] Booking created {"correlationId":"b0cfbf1f-8ad2-4531-8e57-0afae9d0d566","bookingId":"516864d4-755a-46cb-8d3d-5ba2b4f21715","duplicate":false,"initialStatus":"confirmed","durationMs":9344,"maskedEmail":"bo***f@example.com","maskedPhone":"********1515"}
[2025-11-16T10:53:59.360Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"b0cfbf1f-8ad2-4531-8e57-0afae9d0d566","bookingId":"516864d4-755a-46cb-8d3d-5ba2b4f21715","reference":"4N4TTJ69YB","bookingDate":"2026-04-03","startTime":"12:30:00","endTime":"14:00:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:53:58.612Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2591,"attemptId":"c6eeb035-ee20-4631-aaf6-bc0cea268cb1","emailSent":false,"emailVariant":"standard"},"iteration":2,"submitDurationMs":9344,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":9588,"tablesAssigned":1,"totalCapacity":10,"seatWaste":0,"tableNumbers":["MD-12"],"partySize":10,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"2e8360e7-02a2-46c2-9693-9ae65aeea403","tableId":"aa9804d0-fece-4631-b7c3-1e1a5418d05b","tableNumber":"MD-12","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":10,"startAt":null,"endAt":null}]}
[2025-11-16T10:53:59.361Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"2383716b-5b64-4563-a205-6b36f4a2ad03","bookingId":null,"iteration":3,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:53:59.361Z] [INFO] [submit] Submitting booking request {"correlationId":"2383716b-5b64-4563-a205-6b36f4a2ad03","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:30","party":10,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:54:10.136Z] [INFO] [submit] Booking created {"correlationId":"2383716b-5b64-4563-a205-6b36f4a2ad03","bookingId":"50e1978c-84ff-4542-8d17-5cdbd1456e29","duplicate":false,"initialStatus":"confirmed","durationMs":10774,"maskedEmail":"bo***b@example.com","maskedPhone":"********7161"}
[2025-11-16T10:54:10.375Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"2383716b-5b64-4563-a205-6b36f4a2ad03","bookingId":"50e1978c-84ff-4542-8d17-5cdbd1456e29","reference":"Q3FKQTSBBM","bookingDate":"2026-04-03","startTime":"12:30:00","endTime":"14:00:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:54:09.703Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2226,"attemptId":"866288be-dd50-49a4-8f0b-69e42164bfb8","emailSent":false,"emailVariant":"standard"},"iteration":3,"submitDurationMs":10774,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":11014,"tablesAssigned":1,"totalCapacity":10,"seatWaste":0,"tableNumbers":["PR-05"],"partySize":10,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"d4985d4b-20bb-40d5-be7a-79631fbe906e","tableId":"70dd2cff-8340-4745-be99-886dfd278ccb","tableNumber":"PR-05","zoneId":"f830f7d4-ba3c-4290-aa0c-f6576fdbef9d","capacity":10,"startAt":null,"endAt":null}]}
[2025-11-16T10:54:10.376Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"4ab93849-4b1d-462a-ad12-b3751398cefc","bookingId":null,"iteration":4,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:54:10.376Z] [INFO] [submit] Submitting booking request {"correlationId":"4ab93849-4b1d-462a-ad12-b3751398cefc","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:30","party":10,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:54:17.731Z] [INFO] [submit] Booking created {"correlationId":"4ab93849-4b1d-462a-ad12-b3751398cefc","bookingId":"24656183-0414-42d6-9a72-0ea6095c5470","duplicate":false,"initialStatus":"confirmed","durationMs":7354,"maskedEmail":"bo***9@example.com","maskedPhone":"********3849"}
[2025-11-16T10:54:17.989Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"4ab93849-4b1d-462a-ad12-b3751398cefc","bookingId":"24656183-0414-42d6-9a72-0ea6095c5470","reference":"VJYMHHL7FA","bookingDate":"2026-04-03","startTime":"12:30:00","endTime":"14:00:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:54:17.260Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":1889,"attemptId":"1a256f33-6039-49a1-bdf2-0e959d6a98b8","emailSent":false,"emailVariant":"standard"},"iteration":4,"submitDurationMs":7354,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":7613,"tablesAssigned":1,"totalCapacity":10,"seatWaste":0,"tableNumbers":["PR-06"],"partySize":10,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"6d226984-a095-43d1-bfc1-f55cd960bbe4","tableId":"803b084d-ae58-4c26-af01-bc2b79a79181","tableNumber":"PR-06","zoneId":"f830f7d4-ba3c-4290-aa0c-f6576fdbef9d","capacity":10,"startAt":null,"endAt":null}]}
[2025-11-16T10:54:17.989Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"c428f3e8-0fd9-4912-bc51-69d06bfad661","bookingId":null,"iteration":5,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:54:17.989Z] [INFO] [submit] Submitting booking request {"correlationId":"c428f3e8-0fd9-4912-bc51-69d06bfad661","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:30","party":10,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:54:25.266Z] [INFO] [submit] Booking created {"correlationId":"c428f3e8-0fd9-4912-bc51-69d06bfad661","bookingId":"c4bb7755-7280-466f-a16a-8b4f3461142f","duplicate":false,"initialStatus":"confirmed","durationMs":7276,"maskedEmail":"bo***8@example.com","maskedPhone":"********5348"}
[2025-11-16T10:54:25.473Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"c428f3e8-0fd9-4912-bc51-69d06bfad661","bookingId":"c4bb7755-7280-466f-a16a-8b4f3461142f","reference":"PSSBMYQ89U","bookingDate":"2026-04-03","startTime":"12:30:00","endTime":"14:00:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:54:24.831Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2164,"attemptId":"472740b8-e47d-47eb-bcf1-56db438ec57a","emailSent":false,"emailVariant":"standard"},"iteration":5,"submitDurationMs":7276,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":7484,"tablesAssigned":3,"totalCapacity":10,"seatWaste":0,"tableNumbers":["PT-04","PT-01","PT-03"],"partySize":10,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"03b1df58-8530-4fe2-8c73-b7f0a6fa2529","tableId":"17cec96c-ee94-44a7-a329-e9c5386443d8","tableNumber":"PT-04","zoneId":"fe22b647-d1f0-441e-8fc2-74203309cd6b","capacity":4,"startAt":null,"endAt":null},{"id":"3750356d-ead0-45e1-bfa3-0c17684821bd","tableId":"31c0e865-f5ef-453b-a3ef-fe994c8561fa","tableNumber":"PT-01","zoneId":"fe22b647-d1f0-441e-8fc2-74203309cd6b","capacity":2,"startAt":null,"endAt":null},{"id":"0a1ae7f8-1b8a-4d14-aa68-ff882cff166e","tableId":"878bda47-3172-4715-92a8-cf02574680cc","tableNumber":"PT-03","zoneId":"fe22b647-d1f0-441e-8fc2-74203309cd6b","capacity":4,"startAt":null,"endAt":null}]}
[2025-11-16T10:54:25.473Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":null,"iteration":6,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:54:25.473Z] [INFO] [submit] Submitting booking request {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:30","party":10,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:54:31.842Z] [INFO] [submit] Booking created {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","duplicate":false,"initialStatus":"pending","durationMs":6368,"maskedEmail":"bo***e@example.com","maskedPhone":"********4544"}
[2025-11-16T10:54:32.047Z] [INFO] [inline_poll] Status update {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","attempt":1,"status":"pending","assignments":0,"elapsedMs":204}
[2025-11-16T10:54:57.741Z] [WARN] [inline_poll] Inline window expired without confirmation {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","state":"timeout","attempts":12}
[2025-11-16T10:54:57.741Z] [INFO] [background_job] Triggering autoAssignAndConfirmIfPossible {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e"}
[auto-assign][job] scheduled {
  bookingId: '37a098f4-63c9-4df7-8bce-3dc46ccc5c4e',
  reason: 'creation',
  emailVariant: 'standard',
  bypass: true
}
[auto-assign][job] attempt.start {
  bookingId: '37a098f4-63c9-4df7-8bce-3dc46ccc5c4e',
  attempt: 0,
  maxAttempts: 1
}
[auto-assign][job] attempt.error {
  bookingId: '37a098f4-63c9-4df7-8bce-3dc46ccc5c4e',
  attempt: 0,
  error: 'Table bc0740e6-c0a9-49d8-92ca-416bbd0d7d32 is not adjacent to the selected set'
}
[auto-assign][job] exhausted {
  bookingId: '37a098f4-63c9-4df7-8bce-3dc46ccc5c4e',
  attempts: 1,
  maxAttempts: 1
}
[2025-11-16T10:55:02.313Z] [INFO] [background_job] Background auto-assign invoked {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","durationMs":4572}
[2025-11-16T10:55:02.417Z] [INFO] [post_job_poll] Status update {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","attempt":1,"status":"pending","assignments":0,"elapsedMs":104}
[2025-11-16T10:57:32.292Z] [ERROR] [diagnostics] Assignment diagnostics {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","bookingStatus":"pending","assignments":[],"partySize":10,"totalCapacity":0,"seatWaste":0,"lastAutoAssignResult":null,"assignmentStateHistory":[]}
[2025-11-16T10:57:32.292Z] [ERROR] [final_summary] Booking failed to confirm {"correlationId":"804fe5ee-a457-40a0-a915-65dd8cf8da00","bookingId":"37a098f4-63c9-4df7-8bce-3dc46ccc5c4e","state":"timeout","durationMs":186687}
[stress] Summary {
  totalRuns: 6,
  successes: 5,
  failures: 1,
  maxRuns: 6,
  completedTarget: false,
  durationMs: { count: 5, min: 7484, max: 11014, avg: 8948.4, p95: 9588 },
  seatWaste: { count: 5, min: 0, max: 0, avg: 0, p95: 0 },
  tablesPerBooking: { count: 5, min: 1, max: 3, avg: 1.4, p95: 1 },
  uniqueTables: [
    'MD-11', 'MD-12',
    'PR-05', 'PR-06',
    'PT-01', 'PT-03',
    'PT-04'
  ]
}
[stress] Failure details {
  iteration: 6,
  correlationId: '804fe5ee-a457-40a0-a915-65dd8cf8da00',
  status: 'failed_background_timeout',
  failureReason: 'timeout',
  bookingId: '37a098f4-63c9-4df7-8bce-3dc46ccc5c4e'
}
‚ùå Stress run halted after 5 successes; see summary above.
‚ÄâELIFECYCLE‚Äâ Command failed with exit code 1.
