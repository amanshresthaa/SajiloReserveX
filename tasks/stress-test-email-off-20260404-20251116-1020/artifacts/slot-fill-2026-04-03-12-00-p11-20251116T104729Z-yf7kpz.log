
> ship-fast-code@0.1.0 booking:flow /Users/amankumarshrestha/Downloads/SajiloReserveX
> tsx -r tsconfig-paths/register scripts/run-booking-flow.ts --restaurant-slug white-horse-pub-waterbeach --date 2026-04-03 --time 12\:00 --party-size 11 --stress --stress-max 8 --timeout-ms 180000 --base-url http\://localhost\:3000 --pretty

[dotenv@17.2.2] injecting env (0) from .env.local -- tip: ⚙️  write to custom object with { processEnv: myObject }
[dotenv@17.2.2] injecting env (0) from .env.development -- tip: ⚙️  write to custom object with { processEnv: myObject }
[dotenv@17.2.2] injecting env (0) from .env -- tip: ⚙️  load multiple .env files with { path: ['.env.local', '.env'] }
[2025-11-16T10:47:30.179Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"fd299664-5bb7-4208-8bf9-15cf66a149e4","bookingId":null,"iteration":1,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:47:30.179Z] [INFO] [submit] Submitting booking request {"correlationId":"fd299664-5bb7-4208-8bf9-15cf66a149e4","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[supabase] strict hold enforcement active
[2025-11-16T10:47:41.055Z] [INFO] [submit] Booking created {"correlationId":"fd299664-5bb7-4208-8bf9-15cf66a149e4","bookingId":"1a059709-96bd-4a90-816f-e4138009623b","duplicate":false,"initialStatus":"confirmed","durationMs":10874,"maskedEmail":"bo***4@example.com","maskedPhone":"********9664"}
[2025-11-16T10:47:41.354Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"fd299664-5bb7-4208-8bf9-15cf66a149e4","bookingId":"1a059709-96bd-4a90-816f-e4138009623b","reference":"FUDB8CZSGM","bookingDate":"2026-04-03","startTime":"12:00:00","endTime":"13:30:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:47:40.522Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2501,"attemptId":"27d11a90-a3b4-4895-806e-064050d7777e","emailSent":false,"emailVariant":"standard"},"iteration":1,"submitDurationMs":10874,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":11175,"tablesAssigned":2,"totalCapacity":12,"seatWaste":1,"tableNumbers":["MD-07","MD-08"],"partySize":11,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"46d22aa9-74b2-489a-83c7-e962ebe7fdc7","tableId":"36a18791-8339-42c5-a43f-996e2560b240","tableNumber":"MD-07","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":6,"startAt":null,"endAt":null},{"id":"2ee167aa-ca3e-49f0-9720-74f7ba98482c","tableId":"94040fa4-ae8f-44eb-9298-cba491e3d204","tableNumber":"MD-08","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":6,"startAt":null,"endAt":null}]}
[2025-11-16T10:47:41.355Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"d3aca8af-9ee1-4128-acd7-5fa494a30199","bookingId":null,"iteration":2,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:47:41.355Z] [INFO] [submit] Submitting booking request {"correlationId":"d3aca8af-9ee1-4128-acd7-5fa494a30199","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:47:52.894Z] [INFO] [submit] Booking created {"correlationId":"d3aca8af-9ee1-4128-acd7-5fa494a30199","bookingId":"b43f43fc-d77a-4c83-8abb-77870ea81b3f","duplicate":false,"initialStatus":"confirmed","durationMs":11537,"maskedEmail":"bo***f@example.com","maskedPhone":"********0805"}
[2025-11-16T10:47:53.214Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"d3aca8af-9ee1-4128-acd7-5fa494a30199","bookingId":"b43f43fc-d77a-4c83-8abb-77870ea81b3f","reference":"W8TEK8N5DB","bookingDate":"2026-04-03","startTime":"12:00:00","endTime":"13:30:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:47:52.271Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2763,"attemptId":"9306760b-1867-47e7-ae65-53596b7ecfa3","emailSent":false,"emailVariant":"standard"},"iteration":2,"submitDurationMs":11537,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":11859,"tablesAssigned":2,"totalCapacity":12,"seatWaste":1,"tableNumbers":["OG-05","OG-04"],"partySize":11,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"fdb29a30-8cd7-4e69-9eed-a2f33fd76a6f","tableId":"24d44799-86c7-4b2c-aeec-acbcd36f0e69","tableNumber":"OG-05","zoneId":"78d96564-d655-417c-b003-6290bde72dcd","capacity":6,"startAt":null,"endAt":null},{"id":"0496e8b6-bdb1-41f4-ab58-bfe0eb72cf2c","tableId":"42a3ad2c-e3a3-453e-940a-f5e8405f601a","tableNumber":"OG-04","zoneId":"78d96564-d655-417c-b003-6290bde72dcd","capacity":6,"startAt":null,"endAt":null}]}
[2025-11-16T10:47:53.216Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"1a7d5249-701f-483d-9dc3-e0e44ef19e13","bookingId":null,"iteration":3,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:47:53.216Z] [INFO] [submit] Submitting booking request {"correlationId":"1a7d5249-701f-483d-9dc3-e0e44ef19e13","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:48:01.096Z] [INFO] [submit] Booking created {"correlationId":"1a7d5249-701f-483d-9dc3-e0e44ef19e13","bookingId":"8e160d49-a27d-49a7-8dee-85c0c108a686","duplicate":false,"initialStatus":"confirmed","durationMs":7880,"maskedEmail":"bo***9@example.com","maskedPhone":"********5249"}
[2025-11-16T10:48:01.319Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"1a7d5249-701f-483d-9dc3-e0e44ef19e13","bookingId":"8e160d49-a27d-49a7-8dee-85c0c108a686","reference":"8KNF8QHJLT","bookingDate":"2026-04-03","startTime":"12:00:00","endTime":"13:30:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:48:00.573Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2421,"attemptId":"82460155-f998-4dd9-8084-05a1602e564e","emailSent":false,"emailVariant":"standard"},"iteration":3,"submitDurationMs":7880,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":8103,"tablesAssigned":2,"totalCapacity":12,"seatWaste":1,"tableNumbers":["PT-05","PT-06"],"partySize":11,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"7cd77be7-f2a9-4a1b-ba7c-fad0301e8fb4","tableId":"1cc1d9b7-a560-48d0-b290-3c63bf6e7dba","tableNumber":"PT-05","zoneId":"fe22b647-d1f0-441e-8fc2-74203309cd6b","capacity":6,"startAt":null,"endAt":null},{"id":"785fdcff-d6b2-4ff6-9115-3f46dffc01a0","tableId":"714473cf-11f3-4e85-a71e-b598677c9c91","tableNumber":"PT-06","zoneId":"fe22b647-d1f0-441e-8fc2-74203309cd6b","capacity":6,"startAt":null,"endAt":null}]}
[2025-11-16T10:48:01.320Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"17238975-1fb1-4aed-8779-00d673b8d2e2","bookingId":null,"iteration":4,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:48:01.320Z] [INFO] [submit] Submitting booking request {"correlationId":"17238975-1fb1-4aed-8779-00d673b8d2e2","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:48:08.658Z] [INFO] [submit] Booking created {"correlationId":"17238975-1fb1-4aed-8779-00d673b8d2e2","bookingId":"beaf20de-329a-4462-9999-cb2c1a48fcaf","duplicate":false,"initialStatus":"confirmed","durationMs":7337,"maskedEmail":"bo***5@example.com","maskedPhone":"********8975"}
[2025-11-16T10:48:08.876Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"17238975-1fb1-4aed-8779-00d673b8d2e2","bookingId":"beaf20de-329a-4462-9999-cb2c1a48fcaf","reference":"U3TZRSMXDZ","bookingDate":"2026-04-03","startTime":"12:00:00","endTime":"13:30:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:48:08.206Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":2119,"attemptId":"a6f83dcf-5a96-4fee-87fa-7fe697fc18e0","emailSent":false,"emailVariant":"standard"},"iteration":4,"submitDurationMs":7337,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":7556,"tablesAssigned":2,"totalCapacity":12,"seatWaste":1,"tableNumbers":["BA-07","BA-08"],"partySize":11,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"28348fab-d2ba-4f4d-8329-dcb443c5752d","tableId":"15d6a144-c838-440f-9e76-fc415dd1be3f","tableNumber":"BA-07","zoneId":"05e92343-5dfa-446f-b946-eb59dd07b553","capacity":6,"startAt":null,"endAt":null},{"id":"8632510f-a5b0-4e61-a356-2f094addcea9","tableId":"2dcab6f8-ccbc-4d31-bc47-fb82bcdf3122","tableNumber":"BA-08","zoneId":"05e92343-5dfa-446f-b946-eb59dd07b553","capacity":6,"startAt":null,"endAt":null}]}
[2025-11-16T10:48:08.877Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"62845780-a723-45ed-adb0-803632c374a0","bookingId":null,"iteration":5,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:48:08.877Z] [INFO] [submit] Submitting booking request {"correlationId":"62845780-a723-45ed-adb0-803632c374a0","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:48:22.471Z] [INFO] [submit] Booking created {"correlationId":"62845780-a723-45ed-adb0-803632c374a0","bookingId":"58abe4a8-39f3-427d-b5c5-96e4cf0eefd2","duplicate":false,"initialStatus":"confirmed","durationMs":13594,"maskedEmail":"bo***0@example.com","maskedPhone":"********5780"}
[2025-11-16T10:48:22.747Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"62845780-a723-45ed-adb0-803632c374a0","bookingId":"58abe4a8-39f3-427d-b5c5-96e4cf0eefd2","reference":"W4TURMNWNW","bookingDate":"2026-04-03","startTime":"12:00:00","endTime":"13:30:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:48:21.642Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":1869,"attemptId":"03889fd1-598a-42b5-9045-f8332fff3305","emailSent":false,"emailVariant":"standard"},"iteration":5,"submitDurationMs":13594,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":13870,"tablesAssigned":2,"totalCapacity":12,"seatWaste":1,"tableNumbers":["PR-04","PR-03"],"partySize":11,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"7aeae41c-537b-4908-8d4d-da96fe00d912","tableId":"bcc8a889-eb19-4197-a188-83269fa3f7b1","tableNumber":"PR-04","zoneId":"f830f7d4-ba3c-4290-aa0c-f6576fdbef9d","capacity":6,"startAt":null,"endAt":null},{"id":"f64340d5-294c-459b-817a-47e35105a88a","tableId":"c5dab7a4-34fc-4ba0-965a-d3296d96726c","tableNumber":"PR-03","zoneId":"f830f7d4-ba3c-4290-aa0c-f6576fdbef9d","capacity":6,"startAt":null,"endAt":null}]}
[2025-11-16T10:48:22.748Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"c1615f91-ecde-4e06-a84a-ac827bd8dfef","bookingId":null,"iteration":6,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:48:22.748Z] [INFO] [submit] Submitting booking request {"correlationId":"c1615f91-ecde-4e06-a84a-ac827bd8dfef","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:48:34.817Z] [INFO] [submit] Booking created {"correlationId":"c1615f91-ecde-4e06-a84a-ac827bd8dfef","bookingId":"815f24e8-53f6-45e6-b883-cb3f1f21c35a","duplicate":false,"initialStatus":"confirmed","durationMs":12069,"maskedEmail":"bo***1@example.com","maskedPhone":"********5591"}
[2025-11-16T10:48:35.172Z] [INFO] [final_summary] Booking confirmed inline (API response) {"correlationId":"c1615f91-ecde-4e06-a84a-ac827bd8dfef","bookingId":"815f24e8-53f6-45e6-b883-cb3f1f21c35a","reference":"RTBZQ7XVVX","bookingDate":"2026-04-03","startTime":"12:00:00","endTime":"13:30:00","autoAssignLastResult":{"source":"inline","lastAttemptAt":"2025-11-16T10:48:34.316Z","success":true,"reason":null,"strategy":{"maxTables":null,"requireAdjacency":null},"trigger":"inline_creation","alternates":0,"durationMs":3935,"attemptId":"3d911e02-4a78-4a9f-9178-85d74cab72e5","emailSent":false,"emailVariant":"standard"},"iteration":6,"submitDurationMs":12069,"inlineAttempts":0,"inlineDurationMs":0,"postJobAttempts":0,"postJobDurationMs":0,"backgroundInvoked":false,"backgroundDurationMs":null,"totalDurationMs":12424,"tablesAssigned":3,"totalCapacity":12,"seatWaste":1,"tableNumbers":["MD-03","MD-05","MD-04"],"partySize":11,"duplicateRequest":false,"status":"confirmed_inline_api","assignments":[{"id":"2909d918-5c9b-49b8-a7e2-08ce1db29d5c","tableId":"38694eb6-cde9-4253-8b8a-cdcd4b74084e","tableNumber":"MD-03","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":4,"startAt":null,"endAt":null},{"id":"3cd417a5-fb73-4967-9198-b8362b7cd857","tableId":"79590af2-90f6-40d8-8a32-e27579e5b949","tableNumber":"MD-05","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":4,"startAt":null,"endAt":null},{"id":"e7f046c5-9d86-49ff-9012-16b1e166345b","tableId":"c5d016d2-7c61-4038-afc3-220a2fc91ea3","tableNumber":"MD-04","zoneId":"02941be8-0aec-4421-9cd2-9dac380d4b91","capacity":4,"startAt":null,"endAt":null}]}
[2025-11-16T10:48:35.172Z] [INFO] [bootstrap] Starting booking flow {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":null,"iteration":7,"totalRuns":"stress","timeoutMs":180000,"inlineWindowMs":25000,"pollIntervalMs":2000}
[2025-11-16T10:48:35.172Z] [INFO] [submit] Submitting booking request {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":null,"url":"http://localhost:3000/api/bookings","restaurantSlug":"white-horse-pub-waterbeach","restaurantId":null,"date":"2026-04-03","time":"12:00","party":11,"bookingType":"dinner","seating":"any","marketingOptIn":false}
[2025-11-16T10:48:48.402Z] [INFO] [submit] Booking created {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","duplicate":false,"initialStatus":"pending","durationMs":13229,"maskedEmail":"bo***7@example.com","maskedPhone":"********5007"}
[2025-11-16T10:48:48.919Z] [INFO] [inline_poll] Status update {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","attempt":1,"status":"pending","assignments":0,"elapsedMs":517}
[2025-11-16T10:49:15.226Z] [WARN] [inline_poll] Inline window expired without confirmation {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","state":"timeout","attempts":12}
[2025-11-16T10:49:15.229Z] [INFO] [background_job] Triggering autoAssignAndConfirmIfPossible {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d"}
[auto-assign][job] scheduled {
  bookingId: '476e0196-6549-4596-b64b-94ce1f5bf24d',
  reason: 'creation',
  emailVariant: 'standard',
  bypass: true
}
[auto-assign][job] attempt.start {
  bookingId: '476e0196-6549-4596-b64b-94ce1f5bf24d',
  attempt: 0,
  maxAttempts: 1
}
[auto-assign][job] attempt.error {
  bookingId: '476e0196-6549-4596-b64b-94ce1f5bf24d',
  attempt: 0,
  error: 'Table d1f34cf1-07da-4171-84f7-71b4490a7276 is not adjacent to the selected set'
}
[auto-assign][job] exhausted {
  bookingId: '476e0196-6549-4596-b64b-94ce1f5bf24d',
  attempts: 1,
  maxAttempts: 1
}
[2025-11-16T10:49:20.705Z] [INFO] [background_job] Background auto-assign invoked {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","durationMs":5476}
[2025-11-16T10:49:20.809Z] [INFO] [post_job_poll] Status update {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","attempt":1,"status":"pending","assignments":0,"elapsedMs":103}
[2025-11-16T10:51:42.059Z] [ERROR] [diagnostics] Assignment diagnostics {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","bookingStatus":"pending","assignments":[],"partySize":11,"totalCapacity":0,"seatWaste":0,"lastAutoAssignResult":null,"assignmentStateHistory":[]}
[2025-11-16T10:51:42.060Z] [ERROR] [final_summary] Booking failed to confirm {"correlationId":"1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146","bookingId":"476e0196-6549-4596-b64b-94ce1f5bf24d","state":"timeout","durationMs":186758}
[stress] Summary {
  totalRuns: 7,
  successes: 6,
  failures: 1,
  maxRuns: 8,
  completedTarget: false,
  durationMs: {
    count: 6,
    min: 7556,
    max: 13870,
    avg: 10831.166666666666,
    p95: 12424
  },
  seatWaste: { count: 6, min: 1, max: 1, avg: 1, p95: 1 },
  tablesPerBooking: { count: 6, min: 2, max: 3, avg: 2.1666666666666665, p95: 2 },
  uniqueTables: [
    'BA-07', 'BA-08',
    'MD-03', 'MD-04',
    'MD-05', 'MD-07',
    'MD-08', 'OG-04',
    'OG-05', 'PR-03',
    'PR-04', 'PT-05',
    'PT-06'
  ]
}
[stress] Failure details {
  iteration: 7,
  correlationId: '1ee9fa07-4fab-4ae1-95d0-cf4bf0c83146',
  status: 'failed_background_timeout',
  failureReason: 'timeout',
  bookingId: '476e0196-6549-4596-b64b-94ce1f5bf24d'
}
❌ Stress run halted after 6 successes; see summary above.
 ELIFECYCLE  Command failed with exit code 1.
