# Implementation Plan: Pick-a-time service-period defaults

## Objective

Ensure the reservation wizard auto-selects the correct occasion (lunch/drinks/dinner) for a chosen time slot by making service-period ownership deterministic, so customers always see the right context without manual toggling.

## Success Criteria

- [ ] Slots generated by `getRestaurantSchedule` carry a `defaultBookingOption` that reflects service-period precedence: lunch wins 12–15, drinks-only 15–17, dinner wins 17–close.
- [ ] `usePlanStepForm` continues to infer booking type purely from the slot metadata; no UI hacks or additional state are required.
- [ ] Automated tests cover overlapping service periods (and at least one drinks-only window) to guard against regressions.
- [ ] Lint + targeted test suites pass locally.

## Architecture & Components

- `server/restaurants/schedule.ts`
  - Introduce a `resolvePeriodForSlot` helper that inspects every overlapping `restaurant_service_periods` row and determines the winner via priority rules (day-specific > global, shorter duration > longer, catalog order tie-breaker).
  - Keep existing `buildAvailability` usage but feed it with the resolved period.
- `reserve/features/reservations/wizard/services/useTimeSlots.ts` & consumers
  - No structural change; they already rely on `defaultBookingOption`.
- Tests
  - Extend `tests/server/restaurants/schedule.test.ts` with overlap cases (lunch overriding drinks, dinner overriding drinks, drinks-only window) using stub clients.

## Data Flow & API Contracts

- API: `GET /api/restaurants/:slug/schedule` remains unchanged. Response slots still expose `{ value, display, bookingOption, defaultBookingOption, availability }` but `defaultBookingOption` will now respect precedence.
- Under the hood, Supabase data (queried via Supabase CLI if verification is needed) still defines: `restaurant_service_periods` rows with `start_time`, `end_time`, `booking_option`.

## UI/UX States

- Loading/empty/error states in the wizard remain as-is (no visual changes). The only UX difference is the correct default radio/pill selection inside `OccasionPicker` when times fall under lunch/dinner windows.

## Edge Cases

- Times with _only_ drinks coverage (e.g., 15:30) must continue defaulting to drinks.
- If future overlapping options emerge (e.g., brunch), tie-breaking via catalog order still gives deterministic results.
- Closing-time guard: new period resolution must still respect last seating buffer trimming.

## Testing Strategy

- Unit: `tests/server/restaurants/schedule.test.ts` covering new precedence behavior.
- Optionally extend wizard hook/component tests if necessary, but target server-level verification first.
- Lint: `pnpm lint` (focused if available) to ensure style/typing is intact.

## Rollout

- No feature flags required; change is deterministic.
- After merge, monitor booking analytics/logs for spikes in drinks-only bookings during lunch/dinner windows.
- Document outcome in the task folder once verification completes.
