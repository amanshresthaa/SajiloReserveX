# Fix Summary: Ambiguous merge_group_id in confirm_hold_assignment_tx

## Problem
The `confirm_hold_assignment_tx` RPC function was failing with:
```
column reference "merge_group_id" is ambiguous
```

This caused the entire transaction to roll back, preventing table assignments from being written to the database. All /reserve flows (inline confirm and auto-assign retry) were blocked.

## Root Cause
In the function body, line 274 referenced `merge_group_id` without a table qualifier:
```sql
'mergeGroupId', (SELECT merge_group_id FROM tmp_confirm_assignments_tx LIMIT 1)
```

Since both `tmp_confirm_assignments_tx` (temp table) and `public.booking_table_assignments` were in scope, Postgres couldn't resolve which `merge_group_id` column was intended.

## Solution
Fully qualified the column reference with the temp table alias:
```sql
'mergeGroupId', (SELECT tmp.merge_group_id FROM tmp_confirm_assignments_tx tmp LIMIT 1)
```

## Files Changed
1. `supabase/migrations/20251113203000_capacity_overlap_and_confirm_cache.sql` (line 274)
2. `supabase/schema.sql` (line 1597)

## Process Cleanup
- Killed stale Next.js processes (PIDs 81230, 56464)
- Removed `.next/dev/lock` file
- Dev server can now start cleanly

## Next Actions Required

### 1. Deploy to Supabase (Remote Only)
```bash
# Using Supabase CLI
supabase db push --dry-run  # Preview changes
supabase db push            # Apply to remote environment
```

Or use Supabase dashboard to run the updated migration.

### 2. Restart Dev Server
```bash
pnpm run dev
```

### 3. Test Booking Flow
- Navigate to /reserve
- Submit a test booking
- Server logs should show: **"assignment confirmed"** (not "strict hold enforcement")
- Verify rows created in:
  - `booking_table_assignments`
  - `allocations`
  - `capacity_outbox` (with correct mergeGroupId)

### 4. Verification Queries
```sql
-- Check assignments
SELECT * FROM booking_table_assignments 
WHERE booking_id = '<test-booking-id>';

-- Check allocations  
SELECT * FROM allocations 
WHERE booking_id = '<test-booking-id>';

-- Check outbox event
SELECT payload->>'mergeGroupId' 
FROM capacity_outbox 
WHERE booking_id = '<test-booking-id>' 
  AND event_type = 'capacity.assignment.sync';
```

## Risk Assessment
- **Change Type**: SQL function body only (no schema changes)
- **Deployment**: CREATE OR REPLACE FUNCTION (safe, idempotent)
- **Rollback**: Revert to previous function version if issues arise
- **Impact**: HIGH (blocks all table assignments until fixed)

## Task Folder
All documentation in: `tasks/fix-ambiguous-merge-group-id-20251114-0811/`
