# Implementation Plan: Rebuild /ops/manage-restaurant with Full CRUD

## Objective

Build a comprehensive restaurant management interface at `/ops/manage-restaurant` with full CRUD functionality based on the database schema. This replaces the existing page that only managed operational settings.

## Success Criteria

- [ ] Users can view a paginated list of all restaurants they have access to
- [ ] Users can create new restaurants with all required fields
- [ ] Users can update all restaurant fields (name, slug, timezone, capacity, contact info, address, booking policy)
- [ ] Owners can delete restaurants (with confirmation)
- [ ] All operations respect role-based access control
- [ ] Form validation provides clear, actionable feedback
- [ ] UI is fully responsive (mobile, tablet, desktop)
- [ ] Keyboard navigation works throughout
- [ ] No console errors or accessibility violations
- [ ] Manual QA with Chrome DevTools confirms quality

## Architecture

### Component Structure

```
app/(ops)/ops/(app)/manage-restaurant/
  └── page.tsx (Server Component - prefetch, auth)

components/ops/restaurants/
  ├── RestaurantsClient.tsx (Main orchestrator)
  ├── RestaurantsTable.tsx (List view with actions)
  ├── CreateRestaurantDialog.tsx (Create form in dialog)
  ├── EditRestaurantDialog.tsx (Edit form in dialog)
  └── DeleteRestaurantDialog.tsx (Delete confirmation)

app/api/ops/restaurants/
  ├── route.ts (GET list, POST create)
  ├── [id]/route.ts (GET read, PATCH update, DELETE delete)
  └── schema.ts (Zod validation schemas)

server/restaurants/
  ├── create.ts (createRestaurant function)
  ├── delete.ts (deleteRestaurant function)
  ├── list.ts (listRestaurantsForOps function)
  └── update.ts (updateRestaurant function - new, separate from details)

hooks/ops/
  ├── useRestaurants.ts (List query)
  ├── useCreateRestaurant.ts (Create mutation)
  ├── useUpdateRestaurant.ts (Update mutation)
  └── useDeleteRestaurant.ts (Delete mutation)
```

### State Management

- **React Query** for server state (queries + mutations)
- **Local state** for:
  - Dialog open/closed states
  - Form values and validation errors
  - Selected restaurant for edit/delete
  - Pagination (page number)

### Data Flow

1. **List**: Server prefetches → HydrationBoundary → Client renders table
2. **Create**: User clicks "New" → Dialog opens → Form submit → Mutation → Refetch list
3. **Update**: User clicks "Edit" → Dialog opens with data → Form submit → Mutation → Refetch list
4. **Delete**: User clicks "Delete" → Confirmation dialog → Confirm → Mutation → Refetch list

## Database Operations

### Fields in `restaurants` Table

| Field          | Type      | Required | Validation                                |
| -------------- | --------- | -------- | ----------------------------------------- |
| id             | uuid      | Auto     | Generated by DB                           |
| name           | text      | ✅ Yes   | Not empty                                 |
| slug           | text      | ✅ Yes   | Lowercase, alphanumeric + hyphens, unique |
| timezone       | text      | ✅ Yes   | Valid timezone string                     |
| capacity       | integer   | No       | Positive number or null                   |
| contact_email  | text      | No       | Valid email or null                       |
| contact_phone  | text      | No       | Min 5 chars or null                       |
| address        | text      | No       | Any text or null                          |
| booking_policy | text      | No       | Any text or null                          |
| created_at     | timestamp | Auto     | Generated by DB                           |
| updated_at     | timestamp | Auto     | Updated by trigger                        |

### Slug Generation

```typescript
function generateSlug(name: string): string {
  return name
    .toLowerCase()
    .trim()
    .replace(/[^a-z0-9\s-]/g, '') // Remove special chars
    .replace(/\s+/g, '-') // Spaces to hyphens
    .replace(/-+/g, '-') // Multiple hyphens to single
    .replace(/^-|-$/g, ''); // Trim hyphens
}
```

### Access Control

| Operation | Required Role  | Implementation                           |
| --------- | -------------- | ---------------------------------------- |
| List      | Any member     | Filter by user's memberships             |
| Create    | Authenticated  | Auto-add creator as owner in memberships |
| Read      | Any member     | Check membership exists                  |
| Update    | Owner or Admin | Check role in memberships                |
| Delete    | Owner only     | Check role === 'owner'                   |

## API Contracts

### GET `/api/ops/restaurants`

**Query Params**:

```typescript
{
  page?: number;          // Default: 1
  pageSize?: number;      // Default: 20
  search?: string;        // Filter by name
  sort?: 'name' | 'created_at'; // Default: 'name'
}
```

**Response**:

```typescript
{
  items: Restaurant[];
  pageInfo: {
    page: number;
    pageSize: number;
    total: number;
    hasNext: boolean;
  };
}

type Restaurant = {
  id: string;
  name: string;
  slug: string;
  timezone: string;
  capacity: number | null;
  contactEmail: string | null;
  contactPhone: string | null;
  address: string | null;
  bookingPolicy: string | null;
  createdAt: string;
  updatedAt: string;
  role: 'owner' | 'admin' | 'staff' | 'viewer'; // User's role
};
```

### POST `/api/ops/restaurants`

**Request Body**:

```typescript
{
  name: string;                  // Required
  slug?: string;                 // Optional - auto-generated if not provided
  timezone: string;              // Required
  capacity?: number | null;
  contactEmail?: string | null;
  contactPhone?: string | null;
  address?: string | null;
  bookingPolicy?: string | null;
}
```

**Response**:

```typescript
{
  restaurant: Restaurant;
}
```

### PATCH `/api/ops/restaurants/[id]`

**Request Body**:

```typescript
{
  name?: string;
  slug?: string;
  timezone?: string;
  capacity?: number | null;
  contactEmail?: string | null;
  contactPhone?: string | null;
  address?: string | null;
  bookingPolicy?: string | null;
}
```

**Response**:

```typescript
{
  restaurant: Restaurant;
}
```

### DELETE `/api/ops/restaurants/[id]`

**Response**:

```typescript
{
  success: true;
}
```

## UI/UX Design

### Layout

```
┌─────────────────────────────────────────────────┐
│ Manage Restaurants                              │
│ Create, update, and manage your restaurants     │
│                                    [+ New]       │
├─────────────────────────────────────────────────┤
│                                                  │
│ [Search: ________________] [Sort: Name ▼]       │
│                                                  │
│ ┌───────────────────────────────────────────┐  │
│ │ Name          Slug       Capacity  Actions │  │
│ ├───────────────────────────────────────────┤  │
│ │ The Pub       the-pub    100      [Edit]  │  │
│ │                                    [Delete]│  │
│ ├───────────────────────────────────────────┤  │
│ │ Pizza Place   pizza...   50       [Edit]  │  │
│ │                                    [View]  │  │
│ └───────────────────────────────────────────┘  │
│                                                  │
│ Page 1 of 5              [Prev] [Next]          │
└─────────────────────────────────────────────────┘
```

### Create/Edit Dialog

```
┌─────────────────────────────────────────────────┐
│ Create Restaurant                            [X] │
├─────────────────────────────────────────────────┤
│                                                  │
│ Restaurant Name *                                │
│ [_______________________________________]        │
│                                                  │
│ Slug *                                           │
│ [_______________________________________]        │
│ (auto-generated from name)                       │
│                                                  │
│ Timezone *                                       │
│ [Europe/London                           ▼]      │
│                                                  │
│ Capacity                                         │
│ [_______________________________________]        │
│                                                  │
│ Contact Email                                    │
│ [_______________________________________]        │
│                                                  │
│ Contact Phone                                    │
│ [_______________________________________]        │
│                                                  │
│ Address                                          │
│ [_______________________________________]        │
│                                                  │
│ Booking Policy                                   │
│ [                                        ]       │
│ [                                        ]       │
│ [                                        ]       │
│                                                  │
│                          [Cancel] [Create]       │
└─────────────────────────────────────────────────┘
```

### Delete Confirmation

```
┌─────────────────────────────────────────────────┐
│ Delete Restaurant?                           [X] │
├─────────────────────────────────────────────────┤
│                                                  │
│ Are you sure you want to delete "The Pub"?      │
│                                                  │
│ This will permanently delete:                    │
│ • All bookings                                   │
│ • All customers                                  │
│ • Operating hours                                │
│ • Service periods                                │
│ • Team memberships                               │
│                                                  │
│ This action cannot be undone.                    │
│                                                  │
│                          [Cancel] [Delete]       │
└─────────────────────────────────────────────────┘
```

## Implementation Steps

### Phase 0: Setup & Cleanup

1. Create task directory structure
2. Document research findings
3. Create implementation plan
4. Delete existing implementation:
   - Remove `app/(ops)/ops/(app)/manage-restaurant/` directory
   - Remove `components/ops/manage/ManageRestaurantShell.tsx`
   - Update sidebar to point to new page

### Phase 1: Server Layer

1. **Create Zod schemas** (`app/api/ops/restaurants/schema.ts`)
   - `createRestaurantSchema`
   - `updateRestaurantSchema`
   - `listRestaurantsQuerySchema`

2. **Create server functions**:
   - `server/restaurants/create.ts` - `createRestaurant()`
   - `server/restaurants/delete.ts` - `deleteRestaurant()`
   - `server/restaurants/list.ts` - `listRestaurantsForOps()`
   - `server/restaurants/update.ts` - `updateRestaurant()` (full update, not just details)

3. **Create API routes**:
   - `app/api/ops/restaurants/route.ts` - GET (list), POST (create)
   - `app/api/ops/restaurants/[id]/route.ts` - GET, PATCH, DELETE

### Phase 2: Client Hooks

1. **Create React Query hooks** (`hooks/ops/`):
   - `useRestaurants.ts` - List with pagination
   - `useCreateRestaurant.ts` - Create mutation
   - `useUpdateRestaurant.ts` - Update mutation
   - `useDeleteRestaurant.ts` - Delete mutation

### Phase 3: UI Components

1. **Create base components** (`components/ops/restaurants/`):
   - `RestaurantsTable.tsx` - Table with loading/empty states
   - `CreateRestaurantDialog.tsx` - Create form
   - `EditRestaurantDialog.tsx` - Edit form
   - `DeleteRestaurantDialog.tsx` - Confirmation dialog

2. **Create main client component**:
   - `RestaurantsClient.tsx` - Orchestrates all sub-components

### Phase 4: Page & Integration

1. **Create page** (`app/(ops)/ops/(app)/manage-restaurant/page.tsx`):
   - Server component
   - Auth check
   - Prefetch first page
   - Render HydrationBoundary with RestaurantsClient

2. **Update navigation**:
   - Verify sidebar link in `components/ops/AppSidebar.tsx`

### Phase 5: Validation & Error Handling

1. Add form validation:
   - Required field checks
   - Format validation (email, slug pattern)
   - Uniqueness checks (slug)
   - Inline error messages

2. Add error handling:
   - Network errors with retry
   - Validation errors from server
   - Permission errors
   - Loading states on all async actions

### Phase 6: Testing & Refinement

1. Manual testing:
   - Test all CRUD operations
   - Test with different roles (owner, admin, staff)
   - Test validation errors
   - Test pagination
   - Test search/filter
   - Test responsive layouts

2. Chrome DevTools QA:
   - Inspect DOM structure
   - Test mobile viewports
   - Check console for errors
   - Profile performance
   - Run Lighthouse accessibility audit
   - Test keyboard navigation
   - Verify focus management

3. Edge cases:
   - Empty state (no restaurants)
   - Error states (network failure)
   - Permission denied states
   - Concurrent updates
   - Long restaurant names
   - Special characters in inputs

## Edge Cases

### Empty State

- No restaurants to display
- Show call-to-action to create first restaurant
- Provide helpful onboarding text

### Error States

- Network failure → Show retry button
- Permission denied → Show helpful message
- Validation errors → Highlight fields with issues
- Server errors → Log details, show user-friendly message

### Loading States

- Skeleton loaders for initial load
- Disabled buttons during mutations
- Loading spinners on save buttons
- Loading text ("Saving…", "Deleting…")

### Success States

- Toast notification on success
- Optimistic update for better UX
- Redirect to list after create
- Stay on page after update

## Accessibility

### Keyboard Navigation

- Tab through all interactive elements
- Enter to submit forms
- Escape to close dialogs
- Arrow keys in select dropdowns

### Focus Management

- Focus first input when dialog opens
- Return focus to trigger when dialog closes
- Trap focus within modal dialogs
- Visible focus rings on all focusable elements

### ARIA Labels

- `aria-label` on icon buttons
- `aria-describedby` for error messages
- `role="alert"` for validation errors
- `aria-busy` during loading states

### Screen Readers

- Meaningful page title
- Descriptive headings hierarchy
- Table headers with proper scope
- Live regions for dynamic updates

## Performance

### Optimization Strategies

- Prefetch first page on server
- Implement pagination (not all at once)
- Debounce search input
- Optimize re-renders with React.memo where needed
- Use React Query cache effectively

### Metrics

- First Contentful Paint: <1s
- Largest Contentful Paint: <2s
- Time to Interactive: <2.5s
- No Cumulative Layout Shift

## Security

### Input Sanitization

- Trim all text inputs
- Validate email format
- Validate slug pattern
- Prevent SQL injection (handled by Supabase client)
- Prevent XSS (React escapes by default)

### Authorization

- Verify user is authenticated
- Check user has membership to restaurant
- Verify role permissions for each operation
- Use service role client for privileged operations

### Data Protection

- Don't expose sensitive data in client
- Log errors without sensitive details
- Use HTTPS for all requests
- Respect RLS policies

## Rollout Plan

### Pre-Launch

1. Complete implementation
2. Pass all manual tests
3. Pass Chrome DevTools QA
4. Review with team (if applicable)

### Launch

1. Deploy to remote Supabase
2. Test in production environment
3. Monitor for errors
4. Gather initial feedback

### Post-Launch

1. Monitor error logs
2. Track user adoption
3. Collect feedback
4. Plan future enhancements

## Known Limitations

1. **No bulk operations**: Create/update/delete one at a time
2. **Basic search**: Only searches by name (not other fields)
3. **No export**: Cannot export restaurant list to CSV
4. **No archive**: Delete is permanent (no soft delete)

## Future Enhancements (Not in Scope)

1. Bulk import restaurants from CSV
2. Duplicate restaurant feature
3. Advanced filtering (by timezone, capacity range)
4. Restaurant analytics dashboard
5. Audit log of changes
6. Restaurant templates
7. Soft delete with restore capability

## Dependencies

### Required Packages (Already Installed)

- `next` - Framework
- `react`, `react-dom` - UI library
- `@tanstack/react-query` - Data fetching
- `@supabase/supabase-js` - Database client
- `zod` - Validation
- `react-hot-toast` - Notifications

### SHADCN Components (Already Available)

- `Dialog` - Modals
- `Button` - Actions
- `Input`, `Label`, `Textarea` - Form inputs
- `Table` - Data display
- `Alert` - Error messages
- `Card` - Layout containers
- `Skeleton` - Loading states

## Timeline Estimate

1. **Phase 0: Setup & Cleanup** - 30 min
2. **Phase 1: Server Layer** - 2 hours
3. **Phase 2: Client Hooks** - 1 hour
4. **Phase 3: UI Components** - 3 hours
5. **Phase 4: Page & Integration** - 1 hour
6. **Phase 5: Validation & Errors** - 1.5 hours
7. **Phase 6: Testing & QA** - 2 hours

**Total Estimated Time**: ~11 hours

## Success Metrics

1. All CRUD operations work correctly
2. Zero console errors
3. Zero accessibility violations (Lighthouse)
4. Responsive on mobile, tablet, desktop
5. Full keyboard navigation support
6. All edge cases handled gracefully
7. User feedback is clear and actionable

---

**Ready to implement**: Yes
**Blockers**: None
**Open questions**: None
