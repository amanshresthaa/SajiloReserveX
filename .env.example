# -----------------------------------------------------------------------------
# SajiloReserveX - Environment Variables Template
# -----------------------------------------------------------------------------
# Copy this file to .env.local and fill in your actual values
# Never commit .env.local to version control!

# -----------------------------------------------------------------------------
# Mailgun: https://shipfa.st/docs/features/emails
# -----------------------------------------------------------------------------
EMAIL_SERVER=
# MAILGUN_API_KEY=your_mailgun_api_key_here

# -----------------------------------------------------------------------------
# App Configuration
# -----------------------------------------------------------------------------
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_SITE_URL=http://localhost:3000
NEXT_PUBLIC_FORCE_PASSWORD_SIGNIN=false

# üè™ Default Restaurant (from seeded data)
BOOKING_DEFAULT_RESTAURANT_ID=your_restaurant_id_here
NEXT_PUBLIC_DEFAULT_RESTAURANT_ID=your_restaurant_id_here
NEXT_PUBLIC_DEFAULT_RESTAURANT_SLUG=your-restaurant-slug

# Reserve API Configuration
RESERVE_API_BASE_URL=/api
NEXT_PUBLIC_RESERVE_API_BASE_URL=/api

# -----------------------------------------------------------------------------
# Database URI: https://shipfa.st/docs/features/supabase
# -----------------------------------------------------------------------------

# üåê PRODUCTION SUPABASE
PROJECT_URL=your_project_id
NEXT_PUBLIC_SUPABASE_URL=https://your_project_id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key_here
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key_here
SUPABASE_DB_PASSWORD=your_db_password_here
SUPABASE_DB_URL=postgresql://postgres.your_project_id:your_password@aws-0-region.pooler.supabase.com:6543/postgres

# üöÄ LOCAL SUPABASE (For local development)
# Uncomment these and comment out production vars above when developing locally
# PROJECT_URL=local
# NEXT_PUBLIC_SUPABASE_URL=http://127.0.0.1:54321
# NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
# SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU

# Email Configuration
RESEND_API_KEY=your_resend_api_key_here
RESEND_FROM=noreply@yourdomain.com
# Set to true to suppress Resend calls (leave false when you want real emails)
RESEND_USE_MOCK=false
NEXT_PUBLIC_SUPPORT_EMAIL=support@yourdomain.com
SUPPORT_FORWARD_EMAIL=ops@yourdomain.com

# Test email endpoint guardrails
TEST_EMAIL_ACCESS_TOKEN=local-dev-token
TEST_EMAIL_ALLOWED_ORIGINS=http://localhost:3000
TEST_EMAIL_RATE_LIMIT=10

# Magic Link Features
NEXT_PUBLIC_MAGIC_LINK_BOOKING=on
BOOKING_DRAFT_SECRET=your_random_secret_here
NEXT_PUBLIC_MAGIC_LINK_ADMIN=on

# Booking Features
FEATURE_BOOKING_PAST_TIME_BLOCKING=true

# -----------------------------------------------------------------------------
# üéØ Feature Flags - Core Features
# -----------------------------------------------------------------------------
# These control essential booking system features
FEATURE_SELECTOR_SCORING=true
FEATURE_CAPACITY_CONFIG=true
FEATURE_OPS_METRICS=true
FEATURE_ADJACENCY_VALIDATION=true

# Auto-assign tables for new bookings
FEATURE_AUTO_ASSIGN_ON_BOOKING=true
FEATURE_AUTO_ASSIGN_MAX_RETRIES=0
FEATURE_AUTO_ASSIGN_RETRY_DELAYS_MS=0

# -----------------------------------------------------------------------------
# üîó Table Combination Feature
# -----------------------------------------------------------------------------
# Enables the system to assign multiple tables to a single booking
# when a party size cannot be accommodated by a single table.
# 
# Example: Party of 7 ‚Üí Table(4) + Table(4) = 8 seats (1 waste)
#          Instead of: Table(10) = 10 seats (3 waste)
# 
# PRODUCTION RECOMMENDATIONS:
# - Start with combinations ENABLED (better seat utilization)
# - Monitor combination usage % (expect 5-15%)
# - If physical adjacency matters, populate table_adjacencies data
# - Adjust K_MAX based on your restaurant's largest parties

# Enable multi-table combination planning (RECOMMENDED: true)
FEATURE_COMBINATION_PLANNER=true

# Enable table merging logic (RECOMMENDED: true)
FEATURE_ALLOCATOR_MERGES_ENABLED=true

# Max number of tables that can be combined per booking
# Range: 1-5 (RECOMMENDED: 3)
# - 2 = Simple combinations only (2 tables max)
# - 3 = Standard (handles most scenarios)
# - 4-5 = Very large parties (adds computational overhead)
FEATURE_ALLOCATOR_K_MAX=3

# Max combinations to evaluate before timeout
# Range: 100-5000 (RECOMMENDED: 1000)
# - Lower = Faster but may miss optimal combinations
# - Higher = More thorough but slower processing
# - 1000 = Good balance for most restaurants
FEATURE_SELECTOR_MAX_COMBINATION_EVALUATIONS=1000

# Require tables to be physically adjacent when combining
# IMPORTANT: Set based on your table_adjacencies data availability
# 
# true = Only adjacent tables can be combined
#        ‚Üí Requires table_adjacencies table to be populated
#        ‚Üí More logical/aesthetic table groupings
#        ‚Üí Safer for customer experience
# 
# false = Any movable tables in same zone can be combined
#         ‚Üí Works without adjacency data
#         ‚Üí More flexible (may combine distant tables)
#         ‚Üí Good for testing or low-adjacency-concern venues
# 
# PRODUCTION RECOMMENDATION:
# - Set to false initially if no adjacency data
# - Populate table_adjacencies using restaurant floor plans
# - Switch to true once adjacency data is complete
FEATURE_ALLOCATOR_REQUIRE_ADJACENCY=false

# Minimum party size that requires adjacency enforcement
# Only applies when FEATURE_ALLOCATOR_REQUIRE_ADJACENCY=true
# Range: 1-20 (RECOMMENDED: 5-6)
# Example: Set to 6 to enforce adjacency only for parties of 6+
# FEATURE_ALLOCATOR_ADJACENCY_MIN_PARTY_SIZE=5

# -----------------------------------------------------------------------------
# üß† Assignment Pipeline V3 ‚Äî State Machine-Based Assignment
# -----------------------------------------------------------------------------
# The V3 pipeline uses AssignmentCoordinator with state machine transitions,
# distributed locks, rate limiting, and circuit breakers for robust table assignment.
#
# üéØ ROLLOUT STRATEGY (Shadow-First):
#   Phase 1 ‚Äî Staging Shadow:  ENABLED=false, SHADOW=true  (validate without risk)
#   Phase 2 ‚Äî Staging Full:    ENABLED=true,  SHADOW=false (coordinator is primary)
#   Phase 3 ‚Äî Prod Shadow:     ENABLED=false, SHADOW=true  (observe prod traffic)
#   Phase 4 ‚Äî Prod Gradual:    ENABLED=true,  SHADOW=false (10% ‚Üí 50% ‚Üí 100%)
#
# üìä OBSERVABILITY:
#   Monitor `observability_events` table for:
#   - source = 'assignment.state_machine' (state transitions)
#   - event_type = 'booking.assignment_state_transition'
#   - Context: { from, to, version, metadata }
#
# üîç STATE FLOW:
#   created ‚Üí capacity_verified ‚Üí assignment_pending ‚Üí assignment_in_progress
#   ‚Üí assigned ‚Üí confirmed (or manual_review on retry exhaustion)
#
# üìö DOCUMENTATION:
#   Full rollout guide: tasks/enable-assignment-pipeline-v3-20251113-0931/
#   Quick start local: tasks/.../artifacts/QUICK_START_LOCAL.md
#   Environment configs: tasks/.../artifacts/environment-config-guide.md

# Main kill switch: Set to 'true' to enable V3 coordinator (production path)
FEATURE_ASSIGNMENT_PIPELINE_V3=false

# Shadow mode: Set to 'true' to run coordinator in parallel with legacy (no persistence)
# Use for validation before full enablement; compare outcomes via observability events
FEATURE_ASSIGNMENT_PIPELINE_V3_SHADOW=false

# Max concurrent coordinator workers per restaurant (protects against thundering herd)
# RECOMMENDED: Start at 3; increase only after validating lock contention metrics
# Range: 1-20 (enforced in lib/env.ts)
FEATURE_ASSIGNMENT_PIPELINE_V3_MAX_PARALLEL=3
