{
  "files": [
    {
      "path": "src/app/(ops)/ops/(app)/floor-plan/page.tsx",
      "content": "'use client';\n\nimport { useQuery } from '@tanstack/react-query';\nimport {\n    Armchair,\n    Calendar as CalendarIcon,\n    Clock,\n    Info,\n    Loader2,\n    MapPin,\n    Plus,\n    Users,\n    Utensils,\n    X\n} from 'lucide-react';\nimport React, { useMemo, useState } from 'react';\n\nimport { useRestaurantService, useTableInventoryService, useZoneService } from '@/contexts/ops-services';\nimport { useOpsSession } from '@/contexts/ops-session';\nimport { useOpsTableTimeline } from '@/hooks/ops/useOpsTableTimeline';\nimport { queryKeys } from '@/lib/query/keys';\nimport type { TableInventory } from '@/services/ops/tables';\nimport type { TableTimelineSegment } from '@/types/ops';\n\n// --- Utilities ---\n\nfunction parseTimeToMinutes(timeStr: string | null): number {\n    if (!timeStr) return 0;\n    const [hours, minutes] = timeStr.split(':').map(Number);\n    return hours * 60 + minutes;\n}\n\nconst cn = (...classes: (string | undefined | null | false)[]) => classes.filter(Boolean).join(' ');\n\n// --- Components ---\n\ninterface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {\n    variant?: 'default' | 'outline' | 'ghost' | 'secondary';\n    size?: 'default' | 'sm' | 'lg' | 'icon';\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(({ className, variant = 'default', size = 'default', ...props }, ref) => {\n    const variants = {\n        default: 'bg-slate-900 text-white hover:bg-slate-800 shadow-sm',\n        outline: 'border border-slate-200 bg-white hover:bg-slate-50 text-slate-900',\n        ghost: 'hover:bg-slate-100 text-slate-700',\n        secondary: 'bg-slate-100 text-slate-900 hover:bg-slate-200',\n    };\n    const sizes = {\n        default: 'h-10 px-4 py-2',\n        sm: 'h-9 rounded-md px-3 text-xs',\n        lg: 'h-11 rounded-md px-8',\n        icon: 'h-10 w-10',\n    };\n    return (\n        <button\n            className={cn(\n                'inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors disabled:opacity-50 disabled:pointer-events-none',\n                variants[variant] || variants.default,\n                sizes[size] || sizes.default,\n                className\n            )}\n            ref={ref}\n            {...props}\n        />\n    );\n});\n\n// --- Logic Helpers ---\n\nfunction normalizePosition(value: unknown): { x: number; y: number; rotation: number } | null {\n    if (!value || typeof value !== 'object') {\n        return null;\n    }\n    const record = value as Record<string, unknown>;\n    const x = typeof record.x === 'number' ? record.x : null;\n    const y = typeof record.y === 'number' ? record.y : null;\n    if (x === null || y === null) {\n        return null;\n    }\n    const rotation = typeof record.rotation === 'number' ? record.rotation : 0;\n    return { x, y, rotation };\n}\n\nfunction getTableStateAtTime(segments: TableTimelineSegment[], timestamp: number): TableTimelineSegment {\n    const segment = segments.find(s => {\n        const start = new Date(s.start).getTime();\n        const end = new Date(s.end).getTime();\n        return timestamp >= start && timestamp < end;\n    });\n\n    if (segment) return segment;\n\n    // Return a default available segment if none found\n    return {\n        start: new Date(timestamp).toISOString(),\n        end: new Date(timestamp + 3600000).toISOString(),\n        state: 'available',\n        serviceKey: 'other',\n        disabled: false\n    } as TableTimelineSegment;\n}\n\nfunction getStatusColor(state: string) {\n    switch (state) {\n        case 'reserved': return 'bg-rose-500 border-rose-600 text-white shadow-rose-200';\n        case 'hold': return 'bg-amber-400 border-amber-500 text-amber-900 shadow-amber-200';\n        case 'out_of_service': return 'bg-slate-600 border-slate-700 text-white';\n        case 'occupied': return 'bg-blue-500 border-blue-600 text-white shadow-blue-200';\n        case 'available': default: return 'bg-emerald-500 border-emerald-600 text-white shadow-emerald-200';\n    }\n}\n\n// --- Main Component ---\n\nexport default function FloorPlanApp() {\n    const { activeRestaurantId } = useOpsSession();\n    const tableService = useTableInventoryService();\n    const zoneService = useZoneService();\n    const restaurantService = useRestaurantService();\n\n    const [currentTimeVal, setCurrentTimeVal] = useState(18.5 * 60); // Default start\n    const [selectedTableId, setSelectedTableId] = useState<string | null>(null);\n    const [selectedDate, setSelectedDate] = useState<string>(new Date().toISOString().split('T')[0]);\n    const [selectedZoneId, setSelectedZoneId] = useState<string>('all');\n\n    // Fetch Operating Hours & Service Periods\n    const { data: operatingData } = useQuery({\n        queryKey: activeRestaurantId ? ['ops', 'operating-hours', activeRestaurantId] : ['ops', 'operating-hours', 'disabled'],\n        queryFn: async () => {\n            if (!activeRestaurantId) throw new Error('No restaurant ID');\n            const [hours, periods, profile] = await Promise.all([\n                restaurantService.getOperatingHours(activeRestaurantId),\n                restaurantService.getServicePeriods(activeRestaurantId),\n                restaurantService.getProfile(activeRestaurantId)\n            ]);\n            return { hours, periods, profile };\n        },\n        enabled: !!activeRestaurantId\n    });\n\n    // Calculate Timeline Range & Periods for Selected Date\n    const timelineConfig = useMemo(() => {\n        if (!operatingData) return { min: 11 * 60, max: 23 * 60, periods: [] };\n\n        const dayOfWeek = new Date(selectedDate).getDay(); // 0 = Sunday\n        // Adjust for JS getDay() (0=Sun) vs likely DB (1=Mon...7=Sun or 0=Sun) - Assuming 0=Sun matches for now\n\n        const dailyHours = operatingData.hours.weekly.find(h => h.dayOfWeek === dayOfWeek);\n        const periods = operatingData.periods.filter(p => p.dayOfWeek === dayOfWeek);\n\n        let min = 11 * 60;\n        let max = 23 * 60;\n\n        if (dailyHours && dailyHours.opensAt && dailyHours.closesAt) {\n            min = parseTimeToMinutes(dailyHours.opensAt);\n            max = parseTimeToMinutes(dailyHours.closesAt);\n            // Handle late night closing (e.g., 01:00)\n            if (max < min) max += 24 * 60;\n        }\n\n        // Remove buffer to match exact operating hours as requested\n        // min = Math.max(0, min - 30);\n        // max = Math.min(24 * 60 + 300, max + 30); \n\n        const interval = operatingData.profile.reservationIntervalMinutes || 15;\n\n        return { min, max, periods, interval };\n    }, [operatingData, selectedDate]);\n\n    // Update currentTimeVal if it falls out of range when date changes\n    React.useEffect(() => {\n        if (currentTimeVal < timelineConfig.min) setCurrentTimeVal(timelineConfig.min);\n        if (currentTimeVal > timelineConfig.max) setCurrentTimeVal(timelineConfig.max);\n    }, [timelineConfig.min, timelineConfig.max]);\n\n    // Fetch Zones\n    const { data: zones = [] } = useQuery({\n        queryKey: activeRestaurantId ? queryKeys.opsTables.zones(activeRestaurantId) : ['ops', 'zones', 'disabled'],\n        queryFn: async () => {\n            if (!activeRestaurantId) throw new Error('No restaurant ID');\n            return zoneService.list(activeRestaurantId);\n        },\n        enabled: !!activeRestaurantId\n    });\n\n    // Fetch Tables (for layout)\n    const { data: tablesListResult, isLoading: isLoadingTables } = useQuery({\n        queryKey: activeRestaurantId ? queryKeys.opsTables.list(activeRestaurantId) : ['ops', 'tables', 'disabled'],\n        queryFn: async () => {\n            if (!activeRestaurantId) throw new Error('No restaurant ID');\n            return tableService.list(activeRestaurantId);\n        },\n        enabled: !!activeRestaurantId\n    });\n\n    const tables = tablesListResult?.tables ?? [];\n\n    // Fetch Timeline (for status)\n    const { data: timelineData, isLoading: isLoadingTimeline } = useOpsTableTimeline({\n        restaurantId: activeRestaurantId,\n        date: selectedDate,\n        enabled: !!activeRestaurantId\n    });\n\n    const currentTimestamp = useMemo(() => {\n        // Use a fixed date for hydration stability, or ensure selectedDate is stable\n        const date = new Date(selectedDate + 'T00:00:00');\n        return date.getTime() + currentTimeVal * 60000;\n    }, [currentTimeVal, selectedDate]);\n\n    const timeString = useMemo(() => {\n        return new Date(currentTimestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });\n    }, [currentTimestamp]);\n\n    // Merge table layout with timeline status\n    const tablesWithStatus = useMemo(() => {\n        let filteredTables = tables;\n        if (selectedZoneId !== 'all') {\n            filteredTables = tables.filter(t => t.zoneId === selectedZoneId);\n        }\n\n        if (!filteredTables.length) return [];\n\n        // Check if any tables have valid positions\n        const hasPositions = filteredTables.some(t => normalizePosition(t.position) !== null);\n\n        let positionedTables = filteredTables.map(table => {\n            const pos = normalizePosition(table.position);\n            return { ...table, pos };\n        });\n\n        // If no tables have positions, generate a default grid layout\n        if (!hasPositions) {\n            const cols = Math.ceil(Math.sqrt(filteredTables.length));\n            positionedTables = filteredTables.map((table, index) => {\n                const col = index % cols;\n                const row = Math.floor(index / cols);\n                return {\n                    ...table,\n                    pos: {\n                        x: col * 100 + 50, // Spacing of 100 units\n                        y: row * 100 + 50,\n                        rotation: 0\n                    }\n                };\n            });\n        } else {\n            positionedTables = positionedTables.filter(t => t.pos !== null);\n        }\n\n        if (positionedTables.length === 0) return [];\n\n        // Calculate bounds for normalization\n        let minX = Number.POSITIVE_INFINITY;\n        let minY = Number.POSITIVE_INFINITY;\n        let maxX = Number.NEGATIVE_INFINITY;\n        let maxY = Number.NEGATIVE_INFINITY;\n\n        positionedTables.forEach(t => {\n            if (t.pos) {\n                minX = Math.min(minX, t.pos.x);\n                maxX = Math.max(maxX, t.pos.x);\n                minY = Math.min(minY, t.pos.y);\n                maxY = Math.max(maxY, t.pos.y);\n            }\n        });\n\n        const rangeX = Math.max(1, maxX - minX);\n        const rangeY = Math.max(1, maxY - minY);\n\n        // Add significant padding to the range to avoid tables touching the edges\n        // Increased padding to ensure tables are fully visible\n        const paddingX = rangeX * 0.15;\n        const paddingY = rangeY * 0.15;\n\n        const paddedRangeX = rangeX === 0 ? 100 : rangeX + (paddingX * 2);\n        const paddedRangeY = rangeY === 0 ? 100 : rangeY + (paddingY * 2);\n\n        const offsetX = minX - paddingX;\n        const offsetY = minY - paddingY;\n\n        return positionedTables.map(table => {\n            const timelineRow = timelineData?.tables.find(tr => tr.table.id === table.id);\n            const segments = timelineRow?.segments ?? [];\n            const currentStatus = getTableStateAtTime(segments, currentTimestamp);\n\n            // Normalize to 0-100%\n            // If range is 0 (single table), center it\n            let xPercent = 50;\n            let yPercent = 50;\n\n            if (rangeX > 0) {\n                xPercent = ((table.pos!.x - offsetX) / paddedRangeX) * 100;\n            }\n            if (rangeY > 0) {\n                yPercent = ((table.pos!.y - offsetY) / paddedRangeY) * 100;\n            }\n\n            // Clamp values to be safe\n            xPercent = Math.max(2, Math.min(98, xPercent));\n            yPercent = Math.max(2, Math.min(98, yPercent));\n\n            return {\n                ...table,\n                xPercent,\n                yPercent,\n                rotation: table.pos!.rotation,\n                currentStatus,\n                segments\n            };\n        });\n    }, [tables, timelineData, currentTimestamp, selectedZoneId]);\n\n    const selectedTableData = useMemo(() => {\n        if (!selectedTableId) return null;\n        const table = tablesWithStatus.find(t => t.id === selectedTableId);\n        if (!table) return null;\n        return table;\n    }, [selectedTableId, tablesWithStatus]);\n\n    const handleTableClick = (id: string) => {\n        setSelectedTableId(id === selectedTableId ? null : id);\n    };\n\n    if (!activeRestaurantId) {\n        return (\n            <div className=\"flex h-[calc(100vh-8rem)] items-center justify-center bg-slate-50\">\n                <div className=\"text-center\">\n                    <h2 className=\"text-lg font-semibold text-slate-900\">No Restaurant Selected</h2>\n                    <p className=\"text-slate-500\">Please select a restaurant to view the floor plan.</p>\n                </div>\n            </div>\n        );\n    }\n\n    if (isLoadingTables || isLoadingTimeline) {\n        return (\n            <div className=\"flex h-[calc(100vh-8rem)] items-center justify-center bg-slate-50\">\n                <div className=\"flex flex-col items-center gap-2\">\n                    <Loader2 className=\"h-8 w-8 animate-spin text-slate-400\" />\n                    <p className=\"text-slate-500\">Loading floor plan...</p>\n                </div>\n            </div>\n        );\n    }\n\n    return (\n        <div className=\"flex h-[calc(100vh-8rem)] flex-col bg-slate-100 text-slate-900 overflow-hidden font-sans rounded-xl border border-slate-200 shadow-sm\">\n            {/* Top Bar */}\n            <header className=\"flex h-16 shrink-0 items-center justify-between border-b border-slate-200 bg-white px-6 shadow-sm z-10\">\n                <div className=\"flex items-center gap-4\">\n                    <div className=\"flex h-10 w-10 items-center justify-center rounded-xl bg-slate-900 text-white\">\n                        <Utensils className=\"h-5 w-5\" />\n                    </div>\n                    <div>\n                        <h1 className=\"text-lg font-bold leading-tight\">Floor Plan</h1>\n                        <p className=\"text-xs font-medium text-slate-500\">Nov 18, 2025 \u2022 Service Overview</p>\n                    </div>\n                </div>\n\n                <div className=\"flex items-center gap-4\">\n                    {/* Zone Filter */}\n                    <div className=\"hidden lg:flex items-center gap-1 bg-slate-100 p-1 rounded-lg\">\n                        <button\n                            onClick={() => setSelectedZoneId('all')}\n                            className={cn(\n                                \"px-3 py-1 text-xs font-medium rounded-md transition-all\",\n                                selectedZoneId === 'all' ? \"bg-white text-slate-900 shadow-sm\" : \"text-slate-500 hover:text-slate-900\"\n                            )}\n                        >\n                            All\n                        </button>\n                        {zones.map(zone => (\n                            <button\n                                key={zone.id}\n                                onClick={() => setSelectedZoneId(zone.id)}\n                                className={cn(\n                                    \"px-3 py-1 text-xs font-medium rounded-md transition-all\",\n                                    selectedZoneId === zone.id ? \"bg-white text-slate-900 shadow-sm\" : \"text-slate-500 hover:text-slate-900\"\n                                )}\n                            >\n                                {zone.name}\n                            </button>\n                        ))}\n                    </div>\n\n                    <div className=\"relative\">\n                        <div className=\"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none\">\n                            <CalendarIcon className=\"h-4 w-4 text-slate-500\" />\n                        </div>\n                        <input\n                            type=\"date\"\n                            value={selectedDate}\n                            onChange={(e) => setSelectedDate(e.target.value)}\n                            className=\"pl-9 pr-3 py-1.5 text-sm border border-slate-200 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent\"\n                        />\n                    </div>\n                </div>\n            </header>\n\n            <main className=\"flex flex-1 overflow-hidden relative\">\n\n                {/* --- Left: The Floor Plan Canvas --- */}\n                <div className=\"relative flex-1 overflow-hidden bg-slate-100/50 p-6 flex items-center justify-center\">\n\n                    {/* Floor Container */}\n                    <div className=\"relative w-full max-w-5xl aspect-[1.4/1] bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden select-none\">\n\n                        {/* Render Tables */}\n                        {tablesWithStatus.map((table) => {\n                            const status = table.currentStatus;\n                            const isSelected = selectedTableId === table.id;\n                            const colorClass = getStatusColor(status.state);\n\n                            // Use standard width/height styles instead of dynamic tailwind to be safe\n                            const isRound = table.seatingType === 'standard' || table.seatingType === 'high_top';\n                            const widthPercent = isRound ? 5 : 6;\n\n                            return (\n                                <button\n                                    key={table.id}\n                                    onClick={() => handleTableClick(table.id)}\n                                    className={cn(\n                                        \"absolute transition-all duration-300 ease-out flex items-center justify-center shadow-lg border-2 z-10\",\n                                        colorClass,\n                                        isRound ? 'rounded-full' : 'rounded-md',\n                                        isSelected ? \"ring-4 ring-slate-900/20 scale-110 z-20\" : \"hover:scale-105\"\n                                    )}\n                                    style={{\n                                        left: `${table.xPercent}%`,\n                                        top: `${table.yPercent}%`,\n                                        width: `${widthPercent}%`,\n                                        // Use aspect ratio for shape\n                                        aspectRatio: isRound ? '1/1' : '1.4/1',\n                                        transform: `rotate(${table.rotation}deg)`\n                                    }}\n                                >\n                                    <div className=\"flex flex-col items-center\">\n                                        <span className=\"text-[10px] sm:text-sm font-bold leading-none\">{table.tableNumber}</span>\n                                        {status.state === 'reserved' && (\n                                            <div className=\"w-1 h-1 sm:w-1.5 sm:h-1.5 bg-white/50 rounded-full mt-0.5\" />\n                                        )}\n                                    </div>\n\n                                    {/* Chair Indicators */}\n                                    <div className={cn(\"absolute -top-1.5 w-1/2 h-1 rounded-full opacity-30\", colorClass)}></div>\n                                    <div className={cn(\"absolute -bottom-1.5 w-1/2 h-1 rounded-full opacity-30\", colorClass)}></div>\n                                </button>\n                            );\n                        })}\n                    </div>\n\n                    {/* Time Scrubber Floating Control */}\n                    <div className=\"absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-xl px-6\">\n                        <div className=\"bg-white/90 backdrop-blur-md border border-slate-200 rounded-2xl shadow-2xl p-4 flex items-center gap-6\">\n                            <div className=\"flex flex-col items-center min-w-[100px] border-r border-slate-100 pr-6\">\n                                <span className=\"text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1\">Time</span>\n                                <div className=\"flex items-baseline gap-1\">\n                                    <span className=\"text-3xl font-black font-mono tabular-nums text-slate-900 tracking-tight\">\n                                        {new Date(currentTimestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).replace(/\\s[AP]M/, '')}\n                                    </span>\n                                    <span className=\"text-xs font-bold text-slate-400\">\n                                        {new Date(currentTimestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' }).slice(-2)}\n                                    </span>\n                                </div>\n                            </div>\n                            <div className=\"flex-1 relative pt-4 pb-2\">\n                                {/* Service Periods Background */}\n                                <div className=\"absolute top-0 left-0 w-full h-1.5 flex rounded-full overflow-hidden bg-slate-100\">\n                                    {timelineConfig.periods.map((period, idx) => {\n                                        const start = parseTimeToMinutes(period.startTime);\n                                        const end = parseTimeToMinutes(period.endTime);\n                                        const range = timelineConfig.max - timelineConfig.min;\n                                        const left = ((start - timelineConfig.min) / range) * 100;\n                                        const width = ((end - start) / range) * 100;\n\n                                        return (\n                                            <div\n                                                key={idx}\n                                                className=\"absolute h-full bg-slate-200\"\n                                                style={{ left: `${left}%`, width: `${width}%` }}\n                                            />\n                                        );\n                                    })}\n                                </div>\n\n                                {/* Service Period Labels */}\n                                <div className=\"absolute -top-5 left-0 w-full h-full pointer-events-none\">\n                                    {timelineConfig.periods.map((period, idx) => {\n                                        const start = parseTimeToMinutes(period.startTime);\n                                        const end = parseTimeToMinutes(period.endTime);\n                                        const range = timelineConfig.max - timelineConfig.min;\n                                        const left = ((start - timelineConfig.min) / range) * 100;\n                                        const width = ((end - start) / range) * 100;\n\n                                        return (\n                                            <div\n                                                key={idx}\n                                                className=\"absolute text-center\"\n                                                style={{ left: `${left}%`, width: `${width}%` }}\n                                            >\n                                                <span className=\"text-[9px] font-bold uppercase tracking-widest text-slate-400 whitespace-nowrap px-1\">\n                                                    {period.name}\n                                                </span>\n                                            </div>\n                                        );\n                                    })}\n                                </div>\n\n                                {/* Custom Slider */}\n                                <div className=\"relative flex w-full touch-none select-none items-center h-6\">\n                                    {/* Track */}\n                                    <div className=\"absolute w-full h-1.5 bg-slate-100 rounded-full overflow-hidden\">\n                                        <div\n                                            className=\"h-full bg-slate-900 transition-all duration-75 ease-out\"\n                                            style={{ width: `${((currentTimeVal - timelineConfig.min) / (timelineConfig.max - timelineConfig.min)) * 100}%` }}\n                                        />\n                                    </div>\n\n                                    <input\n                                        type=\"range\"\n                                        min={timelineConfig.min}\n                                        max={timelineConfig.max}\n                                        step={timelineConfig.interval}\n                                        value={currentTimeVal}\n                                        onChange={(e) => setCurrentTimeVal(parseFloat(e.target.value))}\n                                        className=\"absolute w-full h-full opacity-0 cursor-pointer z-20\"\n                                    />\n\n                                    {/* Thumb Bubble */}\n                                    <div\n                                        className=\"absolute top-1/2 -translate-y-1/2 h-6 w-6 bg-slate-900 rounded-full shadow-xl border-2 border-white z-10 pointer-events-none transition-all duration-75 ease-out flex items-center justify-center\"\n                                        style={{ left: `${((currentTimeVal - timelineConfig.min) / (timelineConfig.max - timelineConfig.min)) * 100}%`, transform: 'translate(-50%, -50%)' }}\n                                    >\n                                        <div className=\"w-1.5 h-1.5 bg-white rounded-full\" />\n\n                                        {/* Floating Time Label */}\n                                        <div className=\"absolute -top-10 left-1/2 -translate-x-1/2 bg-emerald-500 text-white text-xs font-bold px-2 py-1 rounded shadow-lg whitespace-nowrap\">\n                                            {new Date(currentTimestamp).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}\n                                            <div className=\"absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-emerald-500 rotate-45\"></div>\n                                        </div>\n                                    </div>\n                                </div>\n\n                                <div className=\"relative flex justify-between mt-2 text-[10px] font-medium text-slate-400 uppercase tracking-wide\">\n                                    {(() => {\n                                        // Generate hourly labels\n                                        const startHour = Math.ceil(timelineConfig.min / 60);\n                                        const endHour = Math.floor(timelineConfig.max / 60);\n                                        const hours = [];\n\n                                        // If range is too large, show every 2 hours\n                                        const step = (endHour - startHour) > 12 ? 2 : 1;\n\n                                        for (let h = startHour; h <= endHour; h += step) {\n                                            hours.push(h * 60);\n                                        }\n\n                                        return hours.map((minutes) => {\n                                            const date = new Date();\n                                            date.setHours(0, minutes, 0, 0);\n                                            // Calculate position percentage\n                                            const range = timelineConfig.max - timelineConfig.min;\n                                            const left = ((minutes - timelineConfig.min) / range) * 100;\n\n                                            // Only show if within bounds (0-100%)\n                                            if (left < 0 || left > 100) return null;\n\n                                            return (\n                                                <span\n                                                    key={minutes}\n                                                    className=\"absolute transform -translate-x-1/2\"\n                                                    style={{ left: `${left}%` }}\n                                                >\n                                                    {date.toLocaleTimeString([], { hour: 'numeric' })}\n                                                </span>\n                                            );\n                                        });\n                                    })()}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                </div>\n\n                {/* --- Right: Inspector Panel --- */}\n                <div className={cn(\n                    \"absolute right-0 top-0 h-full w-80 bg-white border-l border-slate-200 shadow-2xl transform transition-transform duration-300 z-30\",\n                    selectedTableId ? \"translate-x-0\" : \"translate-x-full\"\n                )}>\n                    {selectedTableData && (\n                        <div className=\"h-full flex flex-col\">\n                            {/* Panel Header */}\n                            <div className=\"p-6 border-b border-slate-100 bg-slate-50/50\">\n                                <div className=\"flex items-start justify-between\">\n                                    <div>\n                                        <h2 className=\"text-2xl font-bold text-slate-900\">Table {selectedTableData.tableNumber}</h2>\n                                        <div className=\"flex items-center gap-2 mt-1 text-slate-500 text-sm\">\n                                            <MapPin className=\"h-3.5 w-3.5\" />\n                                            {selectedTableData.zoneName || 'No Zone'}\n                                        </div>\n                                    </div>\n                                    <Button variant=\"ghost\" size=\"icon\" onClick={() => setSelectedTableId(null)} className=\"-mr-2 -mt-2\">\n                                        <X className=\"h-4 w-4\" />\n                                    </Button>\n                                </div>\n\n                                <div className=\"flex gap-3 mt-4\">\n                                    <div className=\"flex items-center gap-1.5 text-xs font-medium bg-white px-2.5 py-1.5 rounded border border-slate-200 text-slate-600\">\n                                        <Users className=\"h-3.5 w-3.5\" />\n                                        {selectedTableData.capacity} Seats\n                                    </div>\n                                    <div className=\"flex items-center gap-1.5 text-xs font-medium bg-white px-2.5 py-1.5 rounded border border-slate-200 text-slate-600\">\n                                        <Armchair className=\"h-3.5 w-3.5\" />\n                                        <span className=\"capitalize\">{selectedTableData.seatingType.replace('_', ' ')}</span>\n                                    </div>\n                                </div>\n                            </div>\n\n                            {/* Panel Content */}\n                            <div className=\"flex-1 p-6 overflow-y-auto\">\n                                <div className=\"mb-6\">\n                                    <h3 className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-3\">\n                                        Status at {timeString}\n                                    </h3>\n\n                                    {selectedTableData.currentStatus.state === 'reserved' ? (\n                                        <div className=\"bg-rose-50 border border-rose-100 rounded-xl overflow-hidden\">\n                                            <div className=\"p-4 border-b border-rose-100/50 flex justify-between items-start\">\n                                                <div>\n                                                    <span className=\"text-xs font-bold text-rose-600 uppercase tracking-wider\">Reserved</span>\n                                                    <h4 className=\"text-lg font-bold text-rose-900 mt-1\">\n                                                        {selectedTableData.currentStatus.booking?.customerName || 'Unknown Guest'}\n                                                    </h4>\n                                                </div>\n                                                <div className=\"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors border-transparent bg-rose-500 text-white\">\n                                                    p{selectedTableData.currentStatus.booking?.partySize}\n                                                </div>\n                                            </div>\n                                            <div className=\"p-4 bg-white/50 space-y-3\">\n                                                <div className=\"flex items-center gap-3 text-sm text-rose-900/80\">\n                                                    <Clock className=\"h-4 w-4 text-rose-400\" />\n                                                    <span>\n                                                        {new Date(selectedTableData.currentStatus.start).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })} -\n                                                        {new Date(selectedTableData.currentStatus.end).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}\n                                                    </span>\n                                                </div>\n                                            </div>\n                                            <div className=\"p-2 bg-rose-100/30 border-t border-rose-100 flex gap-2\">\n                                                <Button className=\"w-full bg-white text-rose-600 border border-rose-200 hover:bg-rose-50\" size=\"sm\">\n                                                    View Details\n                                                </Button>\n                                            </div>\n                                        </div>\n                                    ) : selectedTableData.currentStatus.state === 'available' ? (\n                                        <div className=\"text-center py-8 border-2 border-dashed border-emerald-200 rounded-xl bg-emerald-50/30\">\n                                            <div className=\"w-12 h-12 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mx-auto mb-3\">\n                                                <Plus className=\"h-6 w-6\" />\n                                            </div>\n                                            <h4 className=\"font-medium text-emerald-900\">Table Available</h4>\n                                            <p className=\"text-sm text-emerald-600/80 mt-1 mb-4 px-4\">\n                                                This table is free at {timeString}.\n                                            </p>\n                                            <Button className=\"bg-emerald-600 hover:bg-emerald-700 text-white\">\n                                                Walk-in Seating\n                                            </Button>\n                                        </div>\n                                    ) : (\n                                        <div className=\"bg-slate-50 p-4 rounded-xl border border-slate-200\">\n                                            <div className=\"flex items-center gap-3\">\n                                                <div className=\"h-10 w-10 rounded-full bg-slate-200 flex items-center justify-center\">\n                                                    {selectedTableData.currentStatus.state === 'hold' ? <Clock className=\"h-5 w-5 text-slate-500\" /> : <X className=\"h-5 w-5 text-slate-500\" />}\n                                                </div>\n                                                <div>\n                                                    <h4 className=\"font-bold text-slate-700 capitalize\">\n                                                        {selectedTableData.currentStatus.state.replace('_', ' ')}\n                                                    </h4>\n                                                    <p className=\"text-xs text-slate-500\">\n                                                        Until {new Date(selectedTableData.currentStatus.end).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}\n                                                    </p>\n                                                </div>\n                                            </div>\n                                        </div>\n                                    )}\n                                </div>\n\n                                {/* Upcoming for this table */}\n                                <div>\n                                    <h3 className=\"text-xs font-bold text-slate-400 uppercase tracking-wider mb-3\">\n                                        Coming Up Next\n                                    </h3>\n                                    <div className=\"space-y-2\">\n                                        {selectedTableData.segments\n                                            .filter((s: TableTimelineSegment) => new Date(s.start).getTime() > currentTimestamp)\n                                            .slice(0, 3)\n                                            .map((seg: TableTimelineSegment, idx: number) => (\n                                                <div key={idx} className=\"flex items-center p-3 bg-white border border-slate-100 rounded-lg shadow-sm text-sm\">\n                                                    <div className=\"w-16 text-xs font-bold text-slate-500\">\n                                                        {new Date(seg.start).toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' })}\n                                                    </div>\n                                                    <div className=\"flex-1 pl-3 border-l border-slate-100\">\n                                                        {seg.state === 'reserved' ? (\n                                                            <span className=\"font-medium text-slate-900\">{seg.booking?.customerName} (p{seg.booking?.partySize})</span>\n                                                        ) : (\n                                                            <span className=\"text-slate-500 capitalize italic\">{seg.state.replace('_', ' ')}</span>\n                                                        )}\n                                                    </div>\n                                                </div>\n                                            ))}\n                                        {selectedTableData.segments.filter((s: TableTimelineSegment) => new Date(s.start).getTime() > currentTimestamp).length === 0 && (\n                                            <p className=\"text-sm text-slate-400 italic\">No more activity for today.</p>\n                                        )}\n                                    </div>\n                                </div>\n\n                            </div>\n                        </div>\n                    )}\n                </div>\n\n            </main>\n        </div>\n    );\n}\n"
    },
    {
      "path": "src/hooks/ops/useOpsTableTimeline.ts",
      "content": "'use client';\n\nimport { useQuery, useQueryClient } from '@tanstack/react-query';\nimport { useEffect, useMemo } from 'react';\n\nimport { useTableInventoryService } from '@/contexts/ops-services';\nimport { queryKeys } from '@/lib/query/keys';\nimport { getRealtimeSupabaseClient } from '@/lib/supabase/realtime-client';\n\nimport type { TableTimelineResponse } from '@/types/ops';\n\nexport type UseOpsTableTimelineOptions = {\n  restaurantId?: string | null;\n  date?: string | null;\n  zoneId?: string | null;\n  service?: 'lunch' | 'dinner' | 'all';\n  enabled?: boolean;\n};\n\nconst POLL_INTERVAL_MS = 10_000;\n\nexport function useOpsTableTimeline({\n  restaurantId,\n  date,\n  zoneId,\n  service = 'all',\n  enabled = true,\n}: UseOpsTableTimelineOptions) {\n  const tableService = useTableInventoryService();\n  const queryClient = useQueryClient();\n  const queryKey = restaurantId\n    ? queryKeys.opsTables.timeline(restaurantId, { date: date ?? null, zoneId: zoneId ?? null, service })\n    : (['ops', 'tables', 'timeline', 'disabled'] as const);\n  const shouldEnable = Boolean(restaurantId) && enabled;\n\n  const query = useQuery<TableTimelineResponse>({\n    queryKey,\n    queryFn: () => {\n      if (!restaurantId) {\n        throw new Error('Restaurant ID is required to fetch table timeline');\n      }\n      return tableService.timeline(restaurantId, {\n        date: date ?? undefined,\n        zoneId: zoneId ?? undefined,\n        service,\n      });\n    },\n    enabled: shouldEnable,\n    refetchInterval: shouldEnable && !realtimeEnabled() ? POLL_INTERVAL_MS : false,\n    refetchOnWindowFocus: false,\n    staleTime: 5_000,\n  });\n\n  useEffect(() => {\n    if (!shouldEnable || !restaurantId || !realtimeEnabled()) {\n      return;\n    }\n\n    const client = getRealtimeSupabaseClient();\n    const channel = client.channel(`ops-table-timeline:${restaurantId}:${date ?? 'all'}`, {\n      config: { broadcast: { self: false } },\n    });\n\n    const handleChange = () => {\n      queryClient.invalidateQueries({ queryKey, exact: true });\n    };\n\n    channel.on(\n      'postgres_changes',\n      { event: '*', schema: 'public', table: 'allocations', filter: `restaurant_id=eq.${restaurantId}` },\n      handleChange,\n    );\n\n    channel.on(\n      'postgres_changes',\n      { event: '*', schema: 'public', table: 'table_holds', filter: `restaurant_id=eq.${restaurantId}` },\n      handleChange,\n    );\n\n    channel.subscribe();\n\n    return () => {\n      client.removeChannel(channel);\n    };\n  }, [date, queryClient, queryKey, restaurantId, shouldEnable]);\n\n  return query;\n}\n\nfunction realtimeEnabled() {\n  return typeof window !== 'undefined' && process.env.NEXT_PUBLIC_FEATURE_REALTIME_FLOORPLAN === 'true';\n}\n"
    },
    {
      "path": "src/contexts/ops-services.tsx",
      "content": "'use client';\n\nimport { createContext, useContext, useMemo, type ReactNode } from 'react';\n\nimport {\n  createBookingService,\n  type BookingService,\n  type BookingServiceFactory,\n} from '@/services/ops/bookings';\nimport {\n  createCustomerService,\n  type CustomerService,\n  type CustomerServiceFactory,\n} from '@/services/ops/customers';\nimport {\n  createOccasionService,\n  type OccasionService,\n  type OccasionServiceFactory,\n} from '@/services/ops/occasions';\nimport {\n  createRestaurantService,\n  type RestaurantService,\n  type RestaurantServiceFactory,\n} from '@/services/ops/restaurants';\nimport {\n  createTableInventoryService,\n  type TableInventoryService,\n  type TableInventoryServiceFactory,\n} from '@/services/ops/tables';\nimport { createTeamService, type TeamService, type TeamServiceFactory } from '@/services/ops/team';\nimport ZoneService from '@/services/ops/zones';\n\nexport type OpsServices = {\n  bookingService: BookingService;\n  restaurantService: RestaurantService;\n  teamService: TeamService;\n  customerService: CustomerService;\n  tableInventoryService: TableInventoryService;\n  occasionService: OccasionService;\n  zoneService: ZoneService;\n};\n\ntype OpsServiceFactories = {\n  bookingService?: BookingServiceFactory;\n  restaurantService?: RestaurantServiceFactory;\n  teamService?: TeamServiceFactory;\n  customerService?: CustomerServiceFactory;\n  tableInventoryService?: TableInventoryServiceFactory;\n  occasionService?: OccasionServiceFactory;\n  zoneService?: () => ZoneService;\n};\n\ntype OpsServicesProviderProps = {\n  factories?: OpsServiceFactories;\n  children: ReactNode;\n};\n\nconst OpsServicesContext = createContext<OpsServices | null>(null);\n\nexport function OpsServicesProvider({ factories, children }: OpsServicesProviderProps) {\n  const services = useMemo<OpsServices>(\n    () => ({\n      bookingService: createBookingService(factories?.bookingService),\n      restaurantService: createRestaurantService(factories?.restaurantService),\n      teamService: createTeamService(factories?.teamService),\n      customerService: createCustomerService(factories?.customerService),\n      tableInventoryService: createTableInventoryService(factories?.tableInventoryService),\n      occasionService: createOccasionService(factories?.occasionService),\n      zoneService: factories?.zoneService ? factories.zoneService() : new ZoneService(),\n    }),\n    [\n      factories?.bookingService,\n      factories?.restaurantService,\n      factories?.teamService,\n      factories?.customerService,\n      factories?.tableInventoryService,\n      factories?.occasionService,\n      factories?.zoneService,\n    ],\n  );\n\n  return <OpsServicesContext.Provider value={services}>{children}</OpsServicesContext.Provider>;\n}\n\nexport function useOpsServices(): OpsServices {\n  const context = useContext(OpsServicesContext);\n  if (!context) {\n    throw new Error('useOpsServices must be used within an OpsServicesProvider');\n  }\n  return context;\n}\n\nexport function useBookingService(): BookingService {\n  return useOpsServices().bookingService;\n}\n\nexport function useRestaurantService(): RestaurantService {\n  return useOpsServices().restaurantService;\n}\n\nexport function useTeamService(): TeamService {\n  return useOpsServices().teamService;\n}\n\nexport function useCustomerService(): CustomerService {\n  return useOpsServices().customerService;\n}\n\nexport function useTableInventoryService(): TableInventoryService {\n  return useOpsServices().tableInventoryService;\n}\n\nexport function useOccasionService(): OccasionService {\n  return useOpsServices().occasionService;\n}\n\nexport function useZoneService(): ZoneService {\n  return useOpsServices().zoneService;\n}\n"
    },
    {
      "path": "src/services/ops/tables.ts",
      "content": "import { fetchJson } from '@/lib/http/fetchJson';\n\nimport type { OpsServiceError, TableTimelineResponse } from '@/types/ops';\nimport type { Tables } from '@/types/supabase';\n\nconst OPS_TABLES_BASE = '/api/ops/tables';\nconst OPS_TABLE_TIMELINE_BASE = '/api/ops/tables/timeline';\n\ntype TableInventoryRow = Tables<'table_inventory'>;\n\ntype TableInventoryDto = TableInventoryRow & {\n  zone?: { id: string; name: string | null } | null;\n};\n\ntype ServiceCapacitySummaryDto = {\n  key: 'lunch' | 'dinner';\n  label: string;\n  capacity: number;\n  tablesConsidered: number;\n  turnsPerTable: number;\n  seatsPerTurn: number;\n  assumptions: {\n    windowMinutes: number;\n    turnMinutes: number;\n    bufferMinutes: number;\n    intervalMinutes: number | null;\n  };\n};\n\ntype TableInventorySummaryDto = {\n  totalTables: number;\n  totalCapacity: number;\n  availableTables: number;\n  zones: { id: string; name: string }[];\n  serviceCapacities?: ServiceCapacitySummaryDto[];\n};\n\ntype ListTablesResponseDto = {\n  tables: TableInventoryDto[];\n  summary?: TableInventorySummaryDto;\n};\n\nexport type TableInventory = {\n  id: string;\n  restaurantId: string;\n  tableNumber: string;\n  capacity: number;\n  minPartySize: number;\n  maxPartySize: number | null;\n  section: string | null;\n  category: TableInventoryDto['category'];\n  seatingType: TableInventoryDto['seating_type'];\n  mobility: TableInventoryDto['mobility'];\n  zoneId: string;\n  zoneName: string | null;\n  active: boolean;\n  status: TableInventoryDto['status'];\n  position: Record<string, unknown> | null;\n  notes: string | null;\n};\n\nexport type TableInventorySummary = {\n  totalTables: number;\n  totalCapacity: number;\n  availableTables: number;\n  zones: { id: string; name: string }[];\n  serviceCapacities: ServiceCapacitySummaryDto[];\n};\n\nexport type ListTablesParams = {\n  section?: string | null;\n  zoneId?: string | null;\n  status?: TableInventoryDto['status'] | null;\n};\n\nexport type CreateTablePayload = {\n  tableNumber: string;\n  capacity: number;\n  minPartySize: number;\n  maxPartySize?: number | null;\n  section?: string | null;\n  category: TableInventoryDto['category'];\n  seatingType: TableInventoryDto['seating_type'];\n  mobility: TableInventoryDto['mobility'];\n  zoneId: string;\n  status: TableInventoryDto['status'];\n  active: boolean;\n  position?: Record<string, unknown> | null;\n  notes?: string | null;\n};\n\nexport type UpdateTablePayload = Partial<CreateTablePayload> & {\n  tableNumber?: string;\n};\n\nexport type ListTablesResult = {\n  tables: TableInventory[];\n  summary: TableInventorySummary | null;\n};\n\nexport type TableTimelineParams = {\n  date?: string | null;\n  zoneId?: string | null;\n  service?: 'lunch' | 'dinner' | 'all';\n};\n\nexport interface TableInventoryService {\n  list(restaurantId: string, params?: ListTablesParams): Promise<ListTablesResult>;\n  create(restaurantId: string, payload: CreateTablePayload): Promise<TableInventory>;\n  update(tableId: string, payload: UpdateTablePayload): Promise<TableInventory>;\n  remove(tableId: string): Promise<void>;\n  timeline(restaurantId: string, params?: TableTimelineParams): Promise<TableTimelineResponse>;\n}\n\nexport type TableInventoryServiceFactory = () => TableInventoryService;\n\nexport class NotImplementedTableInventoryService implements TableInventoryService {\n  private error(message: string): never {\n    throw new Error(`[ops][tables] ${message}`);\n  }\n\n  list(): Promise<ListTablesResult> {\n    this.error('list not implemented');\n  }\n\n  create(): Promise<TableInventory> {\n    this.error('create not implemented');\n  }\n\n  update(): Promise<TableInventory> {\n    this.error('update not implemented');\n  }\n\n  remove(): Promise<void> {\n    this.error('remove not implemented');\n  }\n\n  timeline(): Promise<TableTimelineResponse> {\n    this.error('timeline not implemented');\n  }\n}\n\nexport function createTableInventoryService(factory?: TableInventoryServiceFactory): TableInventoryService {\n  try {\n    return factory ? factory() : createBrowserTableInventoryService();\n  } catch (error) {\n    if (error instanceof Error) {\n      console.error('[ops][tables] failed to instantiate service', error.message);\n    }\n    return new NotImplementedTableInventoryService();\n  }\n}\n\nexport type TableInventoryServiceError = OpsServiceError | Error;\n\nfunction mapTableInventory(dto: TableInventoryDto): TableInventory {\n  const position = normalizePosition(dto.position);\n  return {\n    id: dto.id,\n    restaurantId: dto.restaurant_id,\n    tableNumber: dto.table_number,\n    capacity: dto.capacity,\n    minPartySize: dto.min_party_size,\n    maxPartySize: dto.max_party_size ?? null,\n    section: dto.section ?? null,\n    category: dto.category,\n    seatingType: dto.seating_type,\n    mobility: dto.mobility,\n    zoneId: dto.zone_id,\n    zoneName: dto.zone?.name ?? null,\n    active: dto.active,\n    status: dto.status,\n    position,\n    notes: dto.notes ?? null,\n  };\n}\n\nfunction normalizePosition(value: TableInventoryDto[\"position\"]): Record<string, unknown> | null {\n  if (!value || typeof value !== 'object') {\n    return null;\n  }\n\n  const { x, y, rotation } = value as { x?: number; y?: number; rotation?: number };\n  if (typeof x !== 'number' || typeof y !== 'number') {\n    return null;\n  }\n\n  const normalized: Record<string, unknown> = {\n    x,\n    y,\n  };\n\n  if (typeof rotation === 'number') {\n    normalized.rotation = rotation;\n  }\n\n  return normalized;\n}\n\nfunction mapSummary(dto: TableInventorySummaryDto | undefined): TableInventorySummary | null {\n  if (!dto) {\n    return null;\n  }\n  return {\n    totalTables: dto.totalTables,\n    totalCapacity: dto.totalCapacity,\n    availableTables: dto.availableTables,\n    zones: dto.zones ?? [],\n    serviceCapacities: dto.serviceCapacities ?? [],\n  };\n}\n\nexport function createBrowserTableInventoryService(): TableInventoryService {\n  return {\n    async list(restaurantId, params = {}) {\n      const searchParams = new URLSearchParams({ restaurantId });\n      if (params.section) {\n        searchParams.set('section', params.section);\n      }\n      if (params.zoneId) {\n        searchParams.set('zoneId', params.zoneId);\n      }\n      if (params.status) {\n        searchParams.set('status', params.status);\n      }\n\n      const response = await fetchJson<ListTablesResponseDto>(`${OPS_TABLES_BASE}?${searchParams.toString()}`);\n      return {\n        tables: (response.tables ?? []).map(mapTableInventory),\n        summary: mapSummary(response.summary),\n      };\n    },\n\n    async create(restaurantId, payload) {\n      const response = await fetchJson<{ table: TableInventoryDto }>(OPS_TABLES_BASE, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          restaurantId,\n          tableNumber: payload.tableNumber,\n          capacity: payload.capacity,\n          minPartySize: payload.minPartySize,\n          maxPartySize: payload.maxPartySize ?? null,\n          section: payload.section ?? null,\n          category: payload.category,\n          seatingType: payload.seatingType,\n          mobility: payload.mobility,\n          zoneId: payload.zoneId,\n          status: payload.status,\n          active: payload.active,\n          position: payload.position ?? null,\n          notes: payload.notes ?? null,\n        }),\n      });\n      return mapTableInventory(response.table);\n    },\n\n    async update(tableId, payload) {\n      const response = await fetchJson<{ table: TableInventoryDto }>(`${OPS_TABLES_BASE}/${tableId}`, {\n        method: 'PATCH',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          tableNumber: payload.tableNumber,\n          capacity: payload.capacity,\n          minPartySize: payload.minPartySize,\n          maxPartySize: payload.maxPartySize,\n          section: payload.section,\n          category: payload.category,\n          seatingType: payload.seatingType,\n          mobility: payload.mobility,\n          zoneId: payload.zoneId,\n          status: payload.status,\n          active: payload.active,\n          position: payload.position ?? null,\n          notes: payload.notes ?? null,\n        }),\n      });\n      return mapTableInventory(response.table);\n    },\n\n    async remove(tableId) {\n      await fetchJson<{ success: boolean }>(`${OPS_TABLES_BASE}/${tableId}`, {\n        method: 'DELETE',\n      });\n    },\n\n    async timeline(restaurantId, params = {}) {\n      const searchParams = new URLSearchParams({ restaurantId });\n      if (params.date) {\n        searchParams.set('date', params.date);\n      }\n      if (params.zoneId) {\n        searchParams.set('zoneId', params.zoneId);\n      }\n      if (params.service && params.service !== 'all') {\n        searchParams.set('service', params.service);\n      }\n\n      return fetchJson<TableTimelineResponse>(`${OPS_TABLE_TIMELINE_BASE}?${searchParams.toString()}`);\n    },\n\n  };\n}\n"
    },
    {
      "path": "src/app/api/ops/tables/route.ts",
      "content": "/**\n * Table Inventory Management API\n * Story 4: Ops Dashboard - Tables CRUD\n *\n * Endpoints:\n * - GET /api/ops/tables - List all tables for a restaurant\n * - POST /api/ops/tables - Create new table\n */\n\nimport { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\n\nimport { ensureAllowedCapacity, findTableByNumber, insertTable, listTablesWithSummary } from \"@/server/ops/tables\";\nimport { getRouteHandlerSupabaseClient } from \"@/server/supabase\";\n\nimport type { TablesInsert } from \"@/types/supabase\";\nimport type { NextRequest} from \"next/server\";\n\n// =====================================================\n// Request Validation\n// =====================================================\n\nconst tableStatusEnum = z.enum([\"available\", \"reserved\", \"occupied\", \"out_of_service\"]);\nconst tableCategoryEnum = z.enum([\"bar\", \"dining\", \"lounge\", \"patio\", \"private\"]);\nconst tableSeatingEnum = z.enum([\"standard\", \"sofa\", \"booth\", \"high_top\"]);\nconst tableMobilityEnum = z.enum([\"movable\", \"fixed\"]);\n\nconst querySchema = z.object({\n  restaurantId: z.string().uuid(),\n  section: z.string().optional(),\n  status: tableStatusEnum.optional(),\n  zoneId: z.string().uuid().optional(),\n});\n\nconst createTableSchema = z.object({\n  restaurantId: z.string().uuid(),\n  tableNumber: z.string().min(1).max(50),\n  capacity: z.number().int().min(1).max(20),\n  minPartySize: z.number().int().min(1).default(1),\n  maxPartySize: z.number().int().min(1).max(20).optional().nullable(),\n  category: tableCategoryEnum.default(\"dining\"),\n  seatingType: tableSeatingEnum.default(\"standard\"),\n  mobility: tableMobilityEnum.default(\"movable\"),\n  zoneId: z.string().uuid(),\n  active: z.boolean().default(true),\n  section: z.string().max(100).optional().nullable(),\n  status: tableStatusEnum.default(\"available\"),\n  position: z\n    .object({\n      x: z.number(),\n      y: z.number(),\n      rotation: z.number().optional(),\n    })\n    .optional()\n    .nullable(),\n  notes: z.string().max(500).optional().nullable(),\n});\n\n// =====================================================\n// GET /api/ops/tables - List tables\n// =====================================================\n\nexport async function GET(req: NextRequest) {\n  try {\n    const supabase = await getRouteHandlerSupabaseClient();\n\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const paramEntries = Object.fromEntries(req.nextUrl.searchParams.entries());\n    const parsed = querySchema.safeParse(paramEntries);\n\n    if (!parsed.success) {\n      return NextResponse.json({ error: \"Invalid query parameters\" }, { status: 400 });\n    }\n\n    const { restaurantId, section, status, zoneId } = parsed.data;\n\n    const filters = {\n      section: section && section.trim().length > 0 ? section : undefined,\n      status,\n      zoneId,\n    } as const;\n\n    const { tables, summary } = await listTablesWithSummary(supabase, restaurantId, filters);\n\n    return NextResponse.json({\n      tables,\n      summary,\n    });\n  } catch (error) {\n    console.error(\"[ops/tables][GET] Unexpected error\", { error });\n    const message = error instanceof Error ? error.message : \"An unexpected error occurred\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n\n// =====================================================\n// POST /api/ops/tables - Create table\n// =====================================================\n\nexport async function POST(req: NextRequest) {\n  try {\n    const supabase = await getRouteHandlerSupabaseClient();\n\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const body = await req.json().catch(() => null);\n    const parsed = createTableSchema.safeParse(body);\n\n    if (!parsed.success) {\n      return NextResponse.json(\n        { error: \"Invalid request body\", details: parsed.error.flatten() },\n        { status: 400 },\n      );\n    }\n\n    const data = parsed.data;\n\n    const { data: membership, error: membershipError } = await supabase\n      .from(\"restaurant_memberships\")\n      .select(\"role\")\n      .eq(\"restaurant_id\", data.restaurantId)\n      .eq(\"user_id\", user.id)\n      .maybeSingle();\n\n    if (membershipError || !membership) {\n      return NextResponse.json({ error: \"Access denied to this restaurant\" }, { status: 403 });\n    }\n\n    const maxPartySize = data.maxPartySize ?? null;\n    if (maxPartySize !== null && maxPartySize < data.minPartySize) {\n      return NextResponse.json({ error: \"maxPartySize must be >= minPartySize\" }, { status: 400 });\n    }\n\n    const { data: zone, error: zoneError } = await supabase\n      .from(\"zones\")\n      .select(\"id, restaurant_id\")\n      .eq(\"id\", data.zoneId)\n      .maybeSingle();\n\n    if (zoneError || !zone) {\n      return NextResponse.json({ error: \"Zone not found\" }, { status: 404 });\n    }\n\n    if (zone.restaurant_id !== data.restaurantId) {\n      return NextResponse.json(\n        { error: \"Zone belongs to a different restaurant\" },\n        { status: 400 },\n      );\n    }\n\n    try {\n      const existing = await findTableByNumber(supabase, data.restaurantId, data.tableNumber.trim());\n      if (existing) {\n        return NextResponse.json(\n          { error: `Table number \"${data.tableNumber}\" already exists` },\n          { status: 409 },\n        );\n      }\n    } catch (lookupError) {\n      console.error(\"[ops/tables][POST] Duplicate check failed\", { error: lookupError });\n      return NextResponse.json({ error: \"Failed to verify table uniqueness\" }, { status: 500 });\n    }\n\n    try {\n      await ensureAllowedCapacity(supabase, data.restaurantId, data.capacity);\n    } catch (capacityError) {\n      console.error(\"[ops/tables][POST] Capacity ensure failed\", { error: capacityError });\n      return NextResponse.json({ error: \"Failed to prepare capacity configuration\" }, { status: 500 });\n    }\n\n    const insertPayload = {\n      restaurant_id: data.restaurantId,\n      table_number: data.tableNumber.trim(),\n      capacity: data.capacity,\n      min_party_size: data.minPartySize,\n      max_party_size: maxPartySize,\n      section: data.section ? data.section.trim() || null : null,\n      category: data.category,\n      seating_type: data.seatingType,\n      mobility: data.mobility,\n      zone_id: data.zoneId,\n      active: data.active,\n      status: data.status,\n      position: data.position ?? null,\n      notes: data.notes ? data.notes.trim() || null : null,\n    } satisfies TablesInsert<\"table_inventory\">;\n\n    try {\n      const table = await insertTable(supabase, insertPayload);\n      return NextResponse.json(\n        {\n          table: {\n            ...table,\n          },\n        },\n        { status: 201 },\n      );\n    } catch (createError) {\n      const errorCode =\n        typeof createError === \"object\" && createError && \"code\" in createError\n          ? (createError as { code?: string }).code\n          : undefined;\n\n      if (errorCode === \"23503\") {\n        return NextResponse.json(\n          { error: \"Capacity is not configured for this restaurant\" },\n          { status: 422 },\n        );\n      }\n\n      console.error(\"[ops/tables][POST] Create error\", { error: createError });\n      return NextResponse.json({ error: \"Failed to create table\" }, { status: 500 });\n    }\n  } catch (error) {\n    console.error(\"[ops/tables][POST] Unexpected error\", { error });\n    const message = error instanceof Error ? error.message : \"An unexpected error occurred\";\n    return NextResponse.json({ error: message }, { status: 500 });\n  }\n}\n"
    },
    {
      "path": "src/app/api/ops/tables/timeline/route.ts",
      "content": "import { NextResponse } from 'next/server';\nimport { z } from 'zod';\n\nimport { getTableAvailabilityTimeline } from '@/server/ops/table-timeline';\nimport { getRouteHandlerSupabaseClient } from '@/server/supabase';\nimport { requireMembershipForRestaurant } from '@/server/team/access';\n\nimport type { NextRequest } from 'next/server';\n\nconst querySchema = z.object({\n  restaurantId: z.string().uuid(),\n  date: z\n    .string()\n    .regex(/^\\d{4}-\\d{2}-\\d{2}$/)\n    .optional(),\n  zoneId: z.string().uuid().optional(),\n  service: z.enum(['lunch', 'dinner', 'all']).optional(),\n});\n\ntype TimelineQuery = z.infer<typeof querySchema>;\n\nfunction parseQuery(request: NextRequest): TimelineQuery | null {\n  const entries = Object.fromEntries(request.nextUrl.searchParams.entries());\n  const result = querySchema.safeParse(entries);\n  if (!result.success) {\n    return null;\n  }\n  return result.data;\n}\n\nexport async function GET(request: NextRequest) {\n  const query = parseQuery(request);\n  if (!query) {\n    return NextResponse.json({ error: 'Invalid query' }, { status: 400 });\n  }\n\n  const supabase = await getRouteHandlerSupabaseClient();\n  const {\n    data: { user },\n    error,\n  } = await supabase.auth.getUser();\n\n  if (error) {\n    console.error('[ops/tables/timeline] failed to resolve auth', error.message);\n    return NextResponse.json({ error: 'Unable to verify session' }, { status: 500 });\n  }\n\n  if (!user) {\n    return NextResponse.json({ error: 'Authentication required' }, { status: 401 });\n  }\n\n  try {\n    await requireMembershipForRestaurant({ userId: user.id, restaurantId: query.restaurantId });\n  } catch (membershipError) {\n    console.error('[ops/tables/timeline] membership validation failed', membershipError);\n    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });\n  }\n\n  try {\n    const timeline = await getTableAvailabilityTimeline({\n      restaurantId: query.restaurantId,\n      date: query.date,\n      zoneId: query.zoneId,\n      service: query.service,\n      client: supabase,\n    });\n\n    return NextResponse.json(timeline);\n  } catch (timelineError) {\n    console.error('[ops/tables/timeline] failed to build timeline', timelineError);\n    return NextResponse.json({ error: 'Unable to load table timeline' }, { status: 500 });\n  }\n}\n"
    },
    {
      "path": "src/app/api/ops/zones/route.ts",
      "content": "import { NextResponse } from \"next/server\";\nimport { z } from \"zod\";\n\nimport { createZone, listZones } from \"@/server/ops/zones\";\nimport { getRouteHandlerSupabaseClient } from \"@/server/supabase\";\n\nimport type { NextRequest} from \"next/server\";\n\nconst querySchema = z.object({\n  restaurantId: z.string().uuid(),\n});\n\nconst createSchema = z.object({\n  restaurantId: z.string().uuid(),\n  name: z.string().min(1).max(100),\n  sortOrder: z.number().int().min(-1000).max(1000).optional(),\n});\n\nexport async function GET(req: NextRequest) {\n  try {\n    const supabase = await getRouteHandlerSupabaseClient();\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\", message: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const searchParams = Object.fromEntries(req.nextUrl.searchParams.entries());\n    const parsed = querySchema.safeParse(searchParams);\n\n    if (!parsed.success) {\n      return NextResponse.json(\n        { error: \"restaurantId is required\", message: \"restaurantId is required\" },\n        { status: 400 },\n      );\n    }\n\n    const { restaurantId } = parsed.data;\n\n    const { data: membership, error: membershipError } = await supabase\n      .from(\"restaurant_memberships\")\n      .select(\"role\")\n      .eq(\"restaurant_id\", restaurantId)\n      .eq(\"user_id\", user.id)\n      .maybeSingle();\n\n    if (membershipError || !membership) {\n      return NextResponse.json(\n        { error: \"Access denied to this restaurant\", message: \"Access denied to this restaurant\" },\n        { status: 403 },\n      );\n    }\n\n    try {\n      const zones = await listZones(supabase, restaurantId);\n      return NextResponse.json({ zones });\n    } catch (error) {\n      console.error(\"[ops/zones][GET] Failed to list zones\", { error });\n      return NextResponse.json(\n        { error: \"Failed to load zones\", message: \"Failed to load zones\" },\n        { status: 500 },\n      );\n    }\n  } catch (error) {\n    console.error(\"[ops/zones][GET] Unexpected error\", { error });\n    return NextResponse.json(\n      { error: \"An unexpected error occurred\", message: \"An unexpected error occurred\" },\n      { status: 500 },\n    );\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const supabase = await getRouteHandlerSupabaseClient();\n    const {\n      data: { user },\n      error: authError,\n    } = await supabase.auth.getUser();\n\n    if (authError || !user) {\n      return NextResponse.json({ error: \"Unauthorized\", message: \"Unauthorized\" }, { status: 401 });\n    }\n\n    const body = await req.json().catch(() => null);\n    const parsed = createSchema.safeParse(body);\n\n    if (!parsed.success) {\n      return NextResponse.json(\n        {\n          error: \"Invalid request body\",\n          message: \"Invalid request body\",\n          details: parsed.error.flatten(),\n        },\n        { status: 400 },\n      );\n    }\n\n    const data = parsed.data;\n\n    const trimmedName = data.name.trim();\n    if (trimmedName.length === 0) {\n      return NextResponse.json(\n        { error: \"Zone name cannot be blank\", message: \"Zone name cannot be blank\" },\n        { status: 400 },\n      );\n    }\n\n    const { data: membership, error: membershipError } = await supabase\n      .from(\"restaurant_memberships\")\n      .select(\"role\")\n      .eq(\"restaurant_id\", data.restaurantId)\n      .eq(\"user_id\", user.id)\n      .maybeSingle();\n\n    if (membershipError || !membership) {\n      return NextResponse.json(\n        { error: \"Access denied to this restaurant\", message: \"Access denied to this restaurant\" },\n        { status: 403 },\n      );\n    }\n\n    try {\n      const zone = await createZone(supabase, {\n        restaurantId: data.restaurantId,\n        name: trimmedName,\n        sortOrder: data.sortOrder ?? 0,\n      });\n      return NextResponse.json({ zone }, { status: 201 });\n    } catch (error) {\n      console.error(\"[ops/zones][POST] Create error\", { error });\n      return NextResponse.json(\n        { error: \"Failed to create zone\", message: \"Failed to create zone\" },\n        { status: 500 },\n      );\n    }\n  } catch (error) {\n    console.error(\"[ops/zones][POST] Unexpected error\", { error });\n    return NextResponse.json(\n      { error: \"An unexpected error occurred\", message: \"An unexpected error occurred\" },\n      { status: 500 },\n    );\n  }\n}\n"
    },
    {
      "path": "src/types/ops.ts",
      "content": "import type { HttpError } from '@/lib/http/errors';\nimport type { RestaurantRole } from '@/lib/owner/auth/roles';\nimport type { OccasionKey } from '@reserve/shared/occasions';\n\nexport type OpsUser = {\n  id: string;\n  email: string | null;\n};\n\nexport type OpsMembership = {\n  restaurantId: string;\n  restaurantName: string;\n  restaurantSlug: string | null;\n  role: RestaurantRole;\n  createdAt: string | null;\n};\n\nexport type OpsAccountSnapshot = {\n  restaurantName: string | null;\n  userEmail: string | null;\n  role: RestaurantRole | null;\n};\n\nexport type OpsPermissionSet = {\n  isAdminAnywhere: boolean;\n  canManageTeam: boolean;\n  canManageSettings: boolean;\n};\n\nexport type OpsFeatureFlags = {\n  opsMetrics: boolean;\n  selectorScoring: boolean;\n  rejectionAnalytics: boolean;\n};\n\nexport type OpsBookingStatus =\n  | 'pending'\n  | 'pending_allocation'\n  | 'confirmed'\n  | 'checked_in'\n  | 'cancelled'\n  | 'completed'\n  | 'no_show';\n\nexport type OpsTodayBooking = {\n  id: string;\n  status: OpsBookingStatus;\n  startTime: string | null;\n  endTime: string | null;\n  partySize: number;\n  customerName: string;\n  customerEmail: string | null;\n  customerPhone: string | null;\n  notes: string | null;\n  reference: string | null;\n  details: Record<string, unknown> | null;\n  source: string | null;\n  loyaltyTier?: 'bronze' | 'silver' | 'gold' | 'platinum' | null;\n  loyaltyPoints?: number | null;\n  profileNotes?: string | null;\n  allergies?: string[] | null;\n  dietaryRestrictions?: string[] | null;\n  seatingPreference?: string | null;\n  marketingOptIn?: boolean | null;\n  tableAssignments: {\n    groupId: string | null;\n    capacitySum: number | null;\n    members: {\n      tableId: string;\n      tableNumber: string;\n      capacity: number | null;\n      section: string | null;\n    }[];\n  }[];\n  requiresTableAssignment: boolean;\n  checkedInAt: string | null;\n  checkedOutAt: string | null;\n};\n\nexport type OpsTodayTotals = {\n  total: number;\n  confirmed: number;\n  completed: number;\n  pending: number;\n  cancelled: number;\n  noShow: number;\n  upcoming: number;\n  covers: number;\n};\n\nexport type OpsTodayBookingsSummary = {\n  date: string;\n  timezone: string;\n  restaurantId: string;\n  totals: OpsTodayTotals;\n  bookings: OpsTodayBooking[];\n};\n\nexport type OpsBookingHeatmap = Record<\n  string,\n  {\n    covers: number;\n    bookings: number;\n  }\n>;\n\nexport type OpsBookingsFilters = {\n  restaurantId: string;\n  page?: number;\n  pageSize?: number;\n  status?: OpsBookingStatus | 'all';\n  sort?: 'asc' | 'desc';\n  sortBy?: 'start_at' | 'created_at';\n  from?: Date | string | null;\n  to?: Date | string | null;\n  query?: string | null;\n  statuses?: OpsBookingStatus[] | null;\n};\n\nexport type OpsWalkInBookingPayload = {\n  restaurantId: string;\n  date: string;\n  time: string;\n  party: number;\n  bookingType: OccasionKey;\n  seating: string;\n  notes?: string | null;\n  name: string;\n  email?: string | null;\n  phone?: string | null;\n  marketingOptIn?: boolean;\n  override?: {\n    apply: boolean;\n    reason?: string | null;\n  } | null;\n};\n\nexport type OpsBookingListItem = {\n  id: string;\n  restaurantId: string | null;\n  restaurantName: string;\n  partySize: number;\n  startIso: string;\n  endIso: string;\n  status: OpsBookingStatus;\n  notes?: string | null;\n  customerName?: string | null;\n  customerEmail?: string | null;\n  customerPhone: string | null;\n};\n\nexport type OpsBookingsPage = {\n  items: OpsBookingListItem[];\n  pageInfo: {\n    page: number;\n    pageSize: number;\n    total: number;\n    hasNext: boolean;\n  };\n};\n\nexport type OpsRestaurantOption = {\n  id: string;\n  name: string;\n  slug?: string | null;\n  timezone?: string | null;\n  address?: string | null;\n};\n\nexport type OpsServiceError = HttpError | Error;\n\nexport type OpsCustomer = {\n  id: string;\n  restaurantId: string;\n  name: string;\n  email: string;\n  phone: string;\n  marketingOptIn: boolean;\n  createdAt: string;\n  firstBookingAt: string | null;\n  lastBookingAt: string | null;\n  totalBookings: number;\n  totalCovers: number;\n  totalCancellations: number;\n};\n\nexport type OpsCustomersPage = {\n  items: OpsCustomer[];\n  pageInfo: {\n    page: number;\n    pageSize: number;\n    total: number;\n    hasNext: boolean;\n  };\n};\n\nexport type OpsRejectionBucket = 'day' | 'hour';\n\nexport type OpsStrategicPenaltyKey = 'slack' | 'scarcity' | 'future_conflict' | 'structural' | 'unknown';\n\nexport type TableTimelineServiceKey = 'lunch' | 'dinner' | 'drinks' | 'other';\n\nexport type TableTimelineSlot = {\n  start: string;\n  end: string;\n  label: string;\n  serviceKey: TableTimelineServiceKey;\n  disabled: boolean;\n};\n\nexport type TableTimelineService = {\n  key: TableTimelineServiceKey;\n  label: string;\n  start: string;\n  end: string;\n  slotCount: number;\n};\n\nexport type TableTimelineBookingRef = {\n  id: string;\n  customerName: string | null;\n  partySize: number;\n  status: OpsBookingStatus;\n  startAt: string;\n  endAt: string;\n};\n\nexport type TableTimelineHoldRef = {\n  id: string;\n  bookingId: string | null;\n  startAt: string;\n  endAt: string;\n};\n\nexport type TableTimelineSegmentState = 'available' | 'reserved' | 'hold' | 'out_of_service';\n\nexport type TableTimelineSegment = {\n  start: string;\n  end: string;\n  state: TableTimelineSegmentState;\n  serviceKey: TableTimelineServiceKey;\n  booking?: TableTimelineBookingRef | null;\n  hold?: TableTimelineHoldRef | null;\n};\n\nexport type TableTimelineRow = {\n  table: {\n    id: string;\n    tableNumber: string;\n    capacity: number;\n    zoneId: string | null;\n    zoneName: string | null;\n    status: 'available' | 'reserved' | 'occupied' | 'out_of_service';\n    active: boolean;\n  };\n  stats: {\n    occupancyMinutes: number;\n    totalMinutes: number;\n    occupancyPercentage: number;\n    nextStateAt: string | null;\n  };\n  segments: TableTimelineSegment[];\n};\n\nexport type TableTimelineResponse = {\n  date: string;\n  timezone: string;\n  window: {\n    start: string;\n    end: string;\n    isClosed: boolean;\n  };\n  slots: TableTimelineSlot[];\n  services: TableTimelineService[];\n  summary: {\n    totalTables: number;\n    totalCapacity: number;\n    availableTables: number;\n    zones: { id: string; name: string }[];\n    serviceCapacities: Array<{\n      key: 'lunch' | 'dinner';\n      label: string;\n      capacity: number;\n      tablesConsidered: number;\n      turnsPerTable: number;\n      seatsPerTurn: number;\n      assumptions: {\n        windowMinutes: number;\n        turnMinutes: number;\n        bufferMinutes: number;\n        intervalMinutes: number | null;\n      };\n    }>;\n  } | null;\n  tables: TableTimelineRow[];\n};\n\nexport type OpsRejectionSeriesPoint = {\n  bucket: string;\n  hard: number;\n  strategic: number;\n};\n\nexport type OpsRejectionTopReason = {\n  label: string;\n  count: number;\n};\n\nexport type OpsRejectionTopPenalty = {\n  penalty: OpsStrategicPenaltyKey;\n  count: number;\n};\n\nexport type OpsStrategicSample = {\n  bookingId: string | null;\n  createdAt: string;\n  skipReason: string | null;\n  dominantPenalty: OpsStrategicPenaltyKey;\n  penalties: {\n    slack: number;\n    scarcity: number;\n    futureConflict: number;\n  };\n  plannerConfig: Record<string, unknown> | null;\n};\n\nexport type OpsRejectionAnalytics = {\n  restaurantId: string;\n  range: {\n    from: string;\n    to: string;\n    bucket: OpsRejectionBucket;\n  };\n  summary: {\n    total: number;\n    hard: {\n      count: number;\n      percent: number;\n      topReasons: OpsRejectionTopReason[];\n    };\n    strategic: {\n      count: number;\n      percent: number;\n      topPenalties: OpsRejectionTopPenalty[];\n    };\n  };\n  series: OpsRejectionSeriesPoint[];\n  strategicSamples: OpsStrategicSample[];\n};\n\nexport type OpsStrategicSettingsSource = 'env' | 'db';\n\nexport type OpsStrategicSettings = {\n  restaurantId: string;\n  source: OpsStrategicSettingsSource;\n  weights: {\n    scarcity: number;\n    demandMultiplier: number | null;\n    futureConflictPenalty: number | null;\n  };\n  updatedAt: string | null;\n};\n"
    }
  ]
}
