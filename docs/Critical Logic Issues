# Critical Logic Issues â€” Remediation Status (2025-10-31)

## 1. Conflicting Adjacency Requirements
- **Status:** Resolved (verification).
- **Action:** Schema migration `20251031162000_drop_table_adjacency_symmetry.sql` removed mirroring trigger; runtime now honours `adjacency.queryUndirected` (see `server/capacity/tables.ts:1433`).

## 2. Zone Consistency Gap in Multi-Table Rules
- **Status:** Resolved.
- **Action:** `assign_tables_atomic_v2` enforces a single zone across historical + new assignments and persists `bookings.assigned_zone_id` (new column, backfill + FK). Blocks mixed-zone merges and stamps zone when first assignment succeeds.

## 3. Hold Conflict Enforcement Inconsistency
- **Status:** Resolved.
- **Action:** Hold triggers now always synchronise `table_hold_windows` and shadow `allocations`; BEFORE insert trigger on assignments removed in favour of DB exclusion, eliminating race. Hold lifecycle catches conflicts via exclusion violations.

## 4. Capacity Validation Timing
- **Status:** Resolved.
- **Action:** New `validate_booking_capacity_after_assignment` runs inside assignment transaction after allocations persist. Raises `capacity_exceeded_post_assignment` if concurrent bookings breach limits.

## 5. Idempotency Key Scope Ambiguity
- **Status:** Resolved.
- **Action:** Added `table_set_hash` column + unique index `(booking_id, table_set_hash)` and hash validation inside RPC. Prevents duplicate table sets under different keys.

## 6. Turn Band Duration vs. Service Period Mismatch
- **Status:** Resolved.
- **Action:** `computeBookingWindow` clamps block end to service boundary, adjusts dining duration, and marks `clampedToServiceEnd` instead of throwing.

## 7. Lookahead Penalties are Advisory Only
- **Status:** Resolved.
- **Action:** `applyLookaheadPenalties` now returns blocked plans and removes candidates exceeding threshold (configurable `blockThreshold`). Diagnostics capture blocked plans and planner exits when all plans rejected.

## 8. Scarcity Fallback Inconsistency
- **Status:** Improved.
- **Action:** Fallback scoring now weighs seat supply with party-size demand weights; logs when heuristic applied. Further tuning may require real demand telemetry.

## 9. Zone Balance Penalty Without Clear Semantics
- **Status:** Deferred.
- **Notes:** Metric unchanged; telemetry captures blocked plans for future analysis. Recommend follow-up to redefine or remove noise once new data collected.

## 10. Manual Selection Hold TTL is Arbitrary
- **Status:** Resolved.
- **Action:** Added `extendTableHold` API + telemetry (`emitHoldExtended`) to renew holds before expiry.

## 11. Cascade Delete on allocations Can Orphan Assignments
- **Status:** Resolved.
- **Action:** `booking_table_assignments` now references `allocations` via FK with backfill script.

## 12. Slot Creation is "Lazy" But Non-Atomic
- **Status:** Resolved.
- **Action:** `get_or_create_booking_slot` uses `INSERT ... ON CONFLICT` to prevent duplicate rows under concurrency.

## 13. Operating Hours Validation is "Best Effort"
- **Status:** Outstanding.
- **Notes:** Procedure still allows bookings when no hours configured. Needs dedicated hard guard + bootstrap migration.

## 14. Advisory Locks are Coarse-Grained
- **Status:** Improved.
- **Action:** Lock key now incorporates time bucket (hour hash) reducing zone-day contention. Monitor lock queue durations for further tuning.

## 15. Exclusion Constraint on allocations is Deferrable
- **Status:** Deferred.
- **Notes:** Constraint remains deferrable; keep monitoring conflict telemetry to assess need for immediate check or shortened transactions.

## 16. DFS Enumeration Can Timeout
- **Status:** Resolved.
- **Action:** DFS now honours wall-clock timeout from feature flags (`selector.enumerationTimeoutMs`), records skip reason `timeout`, and emits warning telemetry.

---

### Additional Notes
- Documentation cross-references updated to reflect new schema columns (`assigned_zone_id`, `allocation_id`, `table_set_hash`).
- Future work items captured for zone balance semantics and operating-hours strict mode.
