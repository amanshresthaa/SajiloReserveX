{
  "flowName": "Customer Booking Edit Flow",
  "description": "Complete end-to-end flow for customers editing their bookings, including frontend UI, API communication, and backend data persistence",
  "version": "1.0.0",
  "lastUpdated": "2025-10-26",
  "flowType": "customer",
  
  "overview": {
    "purpose": "Allow authenticated customers to modify their existing bookings (time, party size, notes) through the dashboard",
    "userRoles": ["authenticated_customer"],
    "entryPoints": [
      "/my-bookings page",
      "Customer dashboard"
    ],
    "dataFlow": "Frontend UI → React Hook → API Endpoint → Database Layer → Supabase",
    "authentication": "Required (session-based)"
  },

  "flowSteps": [
    {
      "step": 1,
      "phase": "initialization",
      "component": "User Interface",
      "action": "Customer clicks edit button on their booking",
      "location": "/my-bookings page",
      "trigger": "User interaction"
    },
    {
      "step": 2,
      "phase": "ui_render",
      "component": "EditBookingDialog",
      "action": "Modal opens with booking data pre-filled",
      "details": {
        "file": "components/dashboard/EditBookingDialog.tsx",
        "responsibilities": [
          "Render modal dialog",
          "Load existing booking data into form",
          "Display ScheduleAwareTimestampPicker for date/time selection",
          "Show availability constraints",
          "Validate form inputs client-side",
          "Handle form submission"
        ],
        "formFields": [
          {
            "name": "start",
            "type": "datetime (ISO 8601)",
            "required": true,
            "validation": "Must be valid future datetime, within operating hours",
            "component": "ScheduleAwareTimestampPicker"
          },
          {
            "name": "partySize",
            "type": "number",
            "required": true,
            "validation": "Min: 1",
            "component": "Input (number)"
          },
          {
            "name": "notes",
            "type": "string",
            "required": false,
            "validation": "Max 500 characters",
            "component": "Textarea"
          }
        ],
        "clientSideValidation": {
          "library": "zod + react-hook-form",
          "schema": "z.object({ start: z.string().min(1).refine(isValidDate), partySize: z.coerce.number().int().min(1), notes: z.string().max(500).nullable().optional() })"
        },
        "uiFeatures": [
          "Auto-calculated end time based on duration",
          "Real-time availability checking",
          "Operating hours enforcement",
          "Past date blocking",
          "Error message display",
          "Save button disabled when invalid or unchanged"
        ]
      }
    },
    {
      "step": 3,
      "phase": "form_submission",
      "component": "useUpdateBooking Hook",
      "action": "Form data sent to backend via mutation",
      "details": {
        "file": "hooks/useUpdateBooking.ts",
        "type": "React Query Mutation Hook",
        "responsibilities": [
          "Execute API call to update booking",
          "Manage loading/error states",
          "Invalidate cached queries on success",
          "Show toast notifications",
          "Emit analytics events"
        ],
        "apiCall": {
          "method": "PUT",
          "endpoint": "/api/bookings/{id}",
          "headers": {
            "Content-Type": "application/json"
          },
          "payloadStructure": {
            "startIso": "string (ISO 8601 datetime)",
            "endIso": "string (ISO 8601 datetime) - optional",
            "partySize": "number",
            "notes": "string | null"
          },
          "examplePayload": {
            "startIso": "2025-10-27T19:00:00.000Z",
            "endIso": "2025-10-27T21:00:00.000Z",
            "partySize": 4,
            "notes": "Window seat preferred"
          }
        },
        "analytics": [
          {
            "event": "booking_edit_submitted",
            "timing": "on mutation start",
            "data": { "bookingId": "string" }
          },
          {
            "event": "booking_edit_succeeded",
            "timing": "on success",
            "data": { "bookingId": "string" }
          },
          {
            "event": "booking_edit_failed",
            "timing": "on error",
            "data": { "bookingId": "string", "code": "string" }
          }
        ],
        "cacheInvalidation": [
          "bookings.*",
          "reservations.schedule.{restaurantSlug}",
          "bookings.detail.{id}",
          "reservations.detail.{id}"
        ],
        "errorHandling": {
          "strategy": "Display toast with user-friendly message",
          "specialCases": {
            "BOOKING_IN_PAST": "Custom message for past bookings"
          }
        }
      }
    },
    {
      "step": 4,
      "phase": "api_routing",
      "component": "Next.js API Route Handler",
      "action": "Request received and routed to PUT handler",
      "details": {
        "file": "src/app/api/bookings/[id]/route.ts",
        "handler": "PUT",
        "responsibilities": [
          "Parse request body",
          "Authenticate user session",
          "Determine update type (dashboard vs legacy)",
          "Validate payload schema",
          "Route to appropriate handler",
          "Return formatted response"
        ],
        "authentication": {
          "method": "Session-based (Supabase Auth)",
          "function": "requireSession()",
          "validates": [
            "Valid session exists",
            "User is authenticated",
            "User email matches booking email"
          ]
        },
        "schemaValidation": {
          "primarySchema": "dashboardUpdateSchema",
          "fields": {
            "startIso": "z.string().datetime()",
            "endIso": "z.string().datetime().optional()",
            "partySize": "z.number().int().min(1)",
            "notes": "z.string().max(500).optional().nullable()"
          },
          "fallbackSchema": "updateSchema (legacy full booking updates)"
        }
      }
    },
    {
      "step": 5,
      "phase": "authorization",
      "component": "processDashboardUpdate",
      "action": "Verify user owns the booking",
      "details": {
        "file": "src/app/api/bookings/[id]/route.ts",
        "function": "processDashboardUpdate",
        "ownershipChecks": [
          {
            "check": "Tenant booking lookup",
            "description": "First check if booking exists in user's tenant database"
          },
          {
            "check": "Restaurant membership",
            "description": "If not found in tenant DB, check if user has restaurant access (ops staff)"
          },
          {
            "check": "Service booking lookup",
            "description": "Look up booking in service database with permission verification"
          }
        ],
        "authorizationRules": {
          "customer": "User email must match booking.customer_email",
          "ops_staff": "User must have membership in booking's restaurant"
        },
        "errors": {
          "FORBIDDEN": "User doesn't own booking or lack permissions",
          "BOOKING_NOT_FOUND": "Booking ID doesn't exist",
          "BOOKING_LOOKUP_FAILED": "Database error during lookup"
        }
      }
    },
    {
      "step": 6,
      "phase": "business_logic",
      "component": "handleDashboardUpdate",
      "action": "Process and validate booking update",
      "details": {
        "file": "src/app/api/bookings/[id]/route.ts",
        "function": "handleDashboardUpdate",
        "responsibilities": [
          "Parse and validate ISO timestamps",
          "Convert to venue timezone",
          "Fetch restaurant schedule",
          "Validate against operating hours",
          "Check for past booking times",
          "Calculate end time and duration",
          "Enforce booking validation rules",
          "Update database record",
          "Log audit event",
          "Enqueue side effects"
        ],
        "timezoneHandling": {
          "steps": [
            "Get restaurant schedule with timezone",
            "Convert ISO timestamps to venue local time",
            "Validate against local operating hours",
            "Store in database as ISO + local components"
          ],
          "functions": [
            "convertIsoToVenueDateTime",
            "convertOptionalIsoToVenueDateTime"
          ]
        },
        "validations": [
          {
            "type": "datetime_parsing",
            "validates": "ISO timestamp is valid date",
            "error": "INVALID_DATE"
          },
          {
            "type": "operating_hours",
            "validates": "Time is within restaurant operating hours",
            "function": "assertBookingWithinOperatingWindow",
            "errors": {
              "CLOSED_DATE": "Restaurant closed on selected date",
              "OUTSIDE_HOURS": "Time outside operating window",
              "INVALID_TIME": "Invalid time format"
            }
          },
          {
            "type": "past_time_blocking",
            "validates": "Booking is not in the past",
            "function": "assertBookingNotInPast",
            "featureFlag": "bookingPastTimeBlocking",
            "gracePeriod": "bookingPastTimeGraceMinutes",
            "error": "BOOKING_IN_PAST"
          },
          {
            "type": "time_range",
            "validates": "End time is after start time",
            "error": "INVALID_TIME_RANGE"
          },
          {
            "type": "unified_validation",
            "validates": "Capacity, overlaps, service periods",
            "featureFlag": "bookingValidationUnified",
            "service": "createBookingValidationService",
            "errors": [
              "CAPACITY_EXCEEDED",
              "OVERLAP_DETECTED",
              "SERVICE_PERIOD",
              "CUTOFF_PASSED"
            ]
          }
        ],
        "durationCalculation": {
          "logic": "If time changed, use schedule or existing duration; if time same, keep existing duration or use explicit endIso",
          "precedence": [
            "schedule.defaultDurationMinutes (if time changed)",
            "existing booking duration",
            "explicit endIso from payload",
            "fallback to 90 minutes"
          ]
        }
      }
    },
    {
      "step": 7,
      "phase": "database_update",
      "component": "updateBookingRecord",
      "action": "Persist changes to database",
      "details": {
        "file": "server/bookings.ts",
        "function": "updateBookingRecord",
        "database": "Supabase PostgreSQL",
        "table": "bookings",
        "responsibilities": [
          "Sanitize and normalize payload",
          "Execute UPDATE query",
          "Return updated record",
          "Invalidate availability cache"
        ],
        "updatePayload": {
          "booking_date": "string (YYYY-MM-DD)",
          "start_time": "string (HH:MM)",
          "end_time": "string (HH:MM)",
          "start_at": "ISO timestamp (auto-calculated)",
          "end_at": "ISO timestamp (auto-calculated)",
          "party_size": "number",
          "notes": "string | null",
          "booking_type": "string (preserved from existing)",
          "seating_preference": "string (preserved from existing)",
          "customer_name": "string (preserved from existing)",
          "customer_email": "string (preserved from existing)",
          "customer_phone": "string (preserved from existing)",
          "marketing_opt_in": "boolean (preserved from existing)"
        },
        "databaseQuery": {
          "operation": "UPDATE",
          "filter": "id = bookingId",
          "returns": "Updated booking record with all fields",
          "select": "BOOKING_SELECT (predefined column list)"
        },
        "sideEffects": [
          "Invalidate availability snapshot cache for (restaurant_id, booking_date)"
        ]
      }
    },
    {
      "step": 8,
      "phase": "audit_logging",
      "component": "logAuditEvent",
      "action": "Record booking modification in audit log",
      "details": {
        "file": "server/bookings.ts",
        "function": "logAuditEvent",
        "purpose": "Compliance and troubleshooting",
        "auditData": {
          "action": "booking.updated",
          "entity": "booking",
          "entityId": "booking ID",
          "actor": "user email or user ID",
          "metadata": {
            "actor_user_id": "string",
            "actor_email": "string | null",
            "restaurant_id": "string",
            "before": "snapshot of old booking values",
            "after": "snapshot of new booking values",
            "changes": "computed diff between before/after"
          }
        },
        "retention": "Stored permanently for compliance"
      }
    },
    {
      "step": 9,
      "phase": "side_effects",
      "component": "enqueueBookingUpdatedSideEffects",
      "action": "Queue background jobs for notifications and integrations",
      "details": {
        "file": "server/jobs/booking-side-effects.ts",
        "function": "enqueueBookingUpdatedSideEffects",
        "jobsEnqueued": [
          {
            "job": "send_booking_confirmation_email",
            "purpose": "Email customer with updated booking details",
            "timing": "async"
          },
          {
            "job": "notify_restaurant_staff",
            "purpose": "Alert restaurant of booking change",
            "timing": "async"
          },
          {
            "job": "update_external_systems",
            "purpose": "Sync with POS, reservation systems, etc.",
            "timing": "async"
          },
          {
            "job": "recalculate_availability",
            "purpose": "Update availability cache",
            "timing": "async"
          }
        ],
        "errorHandling": "Jobs failures logged but don't fail the main update request"
      }
    },
    {
      "step": 10,
      "phase": "response",
      "component": "API Response",
      "action": "Return updated booking data to frontend",
      "details": {
        "httpStatus": 200,
        "contentType": "application/json",
        "responseStructure": {
          "id": "string (UUID)",
          "restaurantName": "string",
          "partySize": "number",
          "startIso": "string (ISO 8601)",
          "endIso": "string (ISO 8601)",
          "status": "string (pending | confirmed | cancelled)",
          "notes": "string | null",
          "reservationIntervalMinutes": "number | null"
        },
        "headers": {
          "validationHeaders": "Added when unified validation is enabled"
        }
      }
    },
    {
      "step": 11,
      "phase": "ui_update",
      "component": "useUpdateBooking Hook",
      "action": "Handle successful response",
      "details": {
        "actions": [
          "Show success toast: 'Booking updated'",
          "Invalidate React Query cache",
          "Trigger refetch of booking list",
          "Emit success analytics event",
          "Close edit dialog"
        ]
      }
    },
    {
      "step": 12,
      "phase": "completion",
      "component": "User Interface",
      "action": "Display updated booking in list",
      "details": {
        "userFeedback": "Toast notification + modal closes",
        "dataRefresh": "Booking list automatically refreshes with updated data",
        "userState": "User sees their updated booking immediately"
      }
    }
  ],

  "errorHandling": {
    "strategy": "Progressive error handling with user-friendly messages",
    "errorCodes": {
      "OVERLAP_DETECTED": {
        "httpStatus": 400,
        "userMessage": "That time overlaps an existing booking. Please choose another slot.",
        "cause": "Time conflict with another booking"
      },
      "CUTOFF_PASSED": {
        "httpStatus": 403,
        "userMessage": "This booking can no longer be changed online. Please contact the venue.",
        "cause": "Past cutoff time for modifications"
      },
      "CLOSED_DATE": {
        "httpStatus": 400,
        "userMessage": "The restaurant is closed on the selected date. Please choose another day.",
        "cause": "Restaurant closed on selected date"
      },
      "BOOKING_NOT_FOUND": {
        "httpStatus": 404,
        "userMessage": "We couldn't find that booking.",
        "cause": "Booking ID doesn't exist"
      },
      "FORBIDDEN": {
        "httpStatus": 403,
        "userMessage": "You don't have permission to modify this booking.",
        "cause": "User doesn't own the booking"
      },
      "UNAUTHENTICATED": {
        "httpStatus": 401,
        "userMessage": "Please sign in again to continue.",
        "cause": "Session expired or invalid"
      },
      "INVALID_INPUT": {
        "httpStatus": 400,
        "userMessage": "Please check the fields and try again.",
        "cause": "Schema validation failed"
      },
      "OUTSIDE_HOURS": {
        "httpStatus": 400,
        "userMessage": "Selected time is outside operating hours. Pick a time between opening and closing.",
        "cause": "Time outside restaurant operating hours"
      },
      "CAPACITY_EXCEEDED": {
        "httpStatus": 400,
        "userMessage": "No availability at that time. Please choose a different time.",
        "cause": "Restaurant at capacity for selected time"
      },
      "PAST_TIME": {
        "httpStatus": 422,
        "userMessage": "That time has already passed. Choose an upcoming slot.",
        "cause": "Selected time is in the past"
      },
      "BOOKING_IN_PAST": {
        "httpStatus": 422,
        "userMessage": "This booking is in the past and cannot be modified.",
        "cause": "Booking time has already occurred"
      },
      "UNKNOWN": {
        "httpStatus": 500,
        "userMessage": "Something went wrong on our side. Please try again.",
        "cause": "Unexpected server error"
      }
    }
  },

  "dataModels": {
    "BookingDTO": {
      "description": "Frontend booking data transfer object",
      "fields": {
        "id": "string (UUID)",
        "restaurantName": "string",
        "restaurantSlug": "string | null",
        "restaurantTimezone": "string | null",
        "partySize": "number",
        "startIso": "string (ISO 8601 timestamp)",
        "endIso": "string (ISO 8601 timestamp)",
        "status": "'pending' | 'pending_allocation' | 'confirmed' | 'cancelled'",
        "notes": "string | null",
        "reservationIntervalMinutes": "number | null"
      }
    },
    "BookingRecord": {
      "description": "Database booking record",
      "table": "bookings",
      "fields": {
        "id": "uuid PRIMARY KEY",
        "restaurant_id": "uuid REFERENCES restaurants",
        "customer_id": "uuid REFERENCES customers",
        "booking_date": "date",
        "start_time": "time",
        "end_time": "time",
        "start_at": "timestamptz",
        "end_at": "timestamptz",
        "party_size": "integer",
        "booking_type": "text",
        "seating_preference": "text",
        "status": "text",
        "customer_name": "text",
        "customer_email": "text",
        "customer_phone": "text",
        "notes": "text",
        "marketing_opt_in": "boolean",
        "created_at": "timestamptz",
        "updated_at": "timestamptz"
      }
    }
  },

  "fileArchitecture": {
    "frontend": [
      {
        "path": "components/dashboard/EditBookingDialog.tsx",
        "purpose": "Edit booking modal UI component",
        "dependencies": [
          "react-hook-form",
          "zod",
          "@hookform/resolvers/zod",
          "react-hot-toast",
          "@/components/ui/*",
          "@/components/features/booking-state-machine"
        ],
        "exports": ["EditBookingDialog", "EditBookingDialogProps"]
      },
      {
        "path": "hooks/useUpdateBooking.ts",
        "purpose": "React Query mutation hook for booking updates",
        "dependencies": [
          "@tanstack/react-query",
          "react-hot-toast",
          "@/lib/http/fetchJson",
          "@/lib/analytics/emit"
        ],
        "exports": ["useUpdateBooking", "UpdateBookingInput"]
      },
      {
        "path": "components/features/booking-state-machine/ScheduleAwareTimestampPicker.tsx",
        "purpose": "Date/time picker with availability awareness",
        "dependencies": ["react", "@/components/ui/*"],
        "exports": ["ScheduleAwareTimestampPicker"]
      }
    ],
    "backend": [
      {
        "path": "src/app/api/bookings/[id]/route.ts",
        "purpose": "API route handler for booking CRUD operations",
        "handlers": ["GET", "PUT", "DELETE"],
        "dependencies": [
          "next",
          "zod",
          "@/server/auth/guards",
          "@/server/bookings",
          "@/server/booking",
          "@/server/supabase"
        ],
        "exports": ["GET", "PUT", "DELETE"]
      },
      {
        "path": "server/bookings.ts",
        "purpose": "Database layer for booking operations",
        "dependencies": ["@/types/supabase"],
        "exports": [
          "updateBookingRecord",
          "fetchBookingsForContact",
          "softCancelBooking",
          "logAuditEvent",
          "buildBookingAuditSnapshot"
        ]
      },
      {
        "path": "server/booking/index.ts",
        "purpose": "Booking validation service",
        "exports": [
          "createBookingValidationService",
          "BookingValidationError"
        ]
      },
      {
        "path": "server/jobs/booking-side-effects.ts",
        "purpose": "Background job orchestration",
        "exports": [
          "enqueueBookingUpdatedSideEffects",
          "enqueueBookingCancelledSideEffects",
          "safeBookingPayload"
        ]
      }
    ]
  },

  "securityConsiderations": {
    "authentication": {
      "method": "Supabase session-based auth",
      "verification": "Every request validates active session",
      "sessionStorage": "HTTP-only cookies"
    },
    "authorization": {
      "rule": "Users can only edit their own bookings",
      "verification": "customer_email must match authenticated user email",
      "exceptions": "Ops staff with restaurant membership can edit any booking for their restaurant"
    },
    "inputValidation": {
      "clientSide": "Zod schema validation in frontend",
      "serverSide": "Zod schema validation in API route",
      "database": "PostgreSQL constraints and RLS policies"
    },
    "auditTrail": {
      "enabled": true,
      "logs": "All modifications logged to audit_events table",
      "includes": "Actor, timestamp, before/after state, IP address"
    }
  },

  "performanceOptimizations": {
    "caching": {
      "reactQuery": "Booking data cached in React Query",
      "invalidation": "Cache invalidated on successful mutation",
      "staleTime": "Configurable per query"
    },
    "databaseQueries": {
      "indexing": "Indexes on booking.id, booking.customer_email, booking.booking_date",
      "selectColumns": "Only necessary columns selected",
      "connectionPooling": "Supabase handles connection pooling"
    },
    "sideEffects": {
      "async": "All notifications and jobs run asynchronously",
      "nonBlocking": "Main request completes before side effects"
    }
  },

  "featureFlags": {
    "bookingPastTimeBlocking": {
      "description": "Block editing bookings that are in the past",
      "default": true,
      "source": "env.featureFlags.bookingPastTimeBlocking"
    },
    "bookingPastTimeGraceMinutes": {
      "description": "Grace period (in minutes) before blocking past bookings",
      "default": 5,
      "source": "env.featureFlags.bookingPastTimeGraceMinutes"
    },
    "bookingValidationUnified": {
      "description": "Use unified validation service for capacity/overlap checks",
      "default": true,
      "source": "env.featureFlags.bookingValidationUnified"
    }
  },

  "testFiles": {
    "unit": [
      {
        "path": "reserve/tests/unit/EditBookingDialog.test.tsx",
        "coverage": "Component rendering, form validation, user interactions"
      }
    ],
    "integration": [
      {
        "path": "src/app/api/bookings/[id]/route.test.ts",
        "coverage": "API endpoint, authentication, authorization, validation"
      }
    ],
    "e2e": [
      {
        "path": "tests/e2e/booking-edit.spec.ts",
        "coverage": "End-to-end edit flow from UI to database"
      }
    ]
  },

  "relatedDocumentation": [
    "tasks/booking-edit-modal-refactor-20251025-2340/verification.md",
    "tasks/rebuild-edit-booking-picker-20251025-2216/plan.md",
    "tasks/calendar-component-reuse-20251025-1109/research.md",
    "docs/architecture/booking-flow.md"
  ],

  "futureEnhancements": [
    "Real-time conflict detection with WebSocket",
    "Optimistic UI updates",
    "Undo/redo functionality",
    "Bulk booking edits",
    "Recurring booking pattern support",
    "Mobile app integration"
  ]
}
