# Migration: Add Booking Confirmation Token

**Migration ID**: `20250115071800_add_booking_confirmation_token.sql`  
**Sprint**: Route Versioning & Auth Cleanup (EPIC B3)  
**Author**: System  
**Date**: 2025-01-15  
**Jira/Task**: route-versioning-auth-cleanup-20251015-0704

---

## Purpose

Adds confirmation token functionality to the `bookings` table to enable secure, time-limited guest access to booking confirmation pages without requiring authentication.

**Problem Solved**: Currently, the `/thank-you` confirmation page requires authentication, forcing guests to create an account after booking. This causes friction in the user flow and reduces conversion.

**Solution**: Generate a one-time, cryptographic confirmation token upon booking creation. Guests can access their booking details via `/thank-you?token=xxx` without signing in. Tokens expire after 1 hour and can only be used once.

---

## Changes

### New Columns in `public.bookings`

| Column                          | Type        | Nullable | Description                                              |
| ------------------------------- | ----------- | -------- | -------------------------------------------------------- |
| `confirmation_token`            | VARCHAR(64) | YES      | Cryptographic token (base64url-encoded, 32 bytes random) |
| `confirmation_token_expires_at` | TIMESTAMPTZ | YES      | Expiry timestamp (1 hour from creation)                  |
| `confirmation_token_used_at`    | TIMESTAMPTZ | YES      | Timestamp of first use (prevents replay)                 |

### Constraints

- **UNIQUE**: `confirmation_token` (ensures no collisions)

### Indexes

- **idx_bookings_confirmation_token** (partial index on non-null tokens for fast lookup)

---

## Security Considerations

1. **Token Strength**: 32 bytes of cryptographic randomness = 256 bits of entropy
2. **Expiry**: 1-hour window limits exposure
3. **One-Time Use**: `confirmation_token_used_at` prevents token replay
4. **Rate Limiting**: API endpoint `/api/bookings/confirm` rate-limited to 20 req/min
5. **No PII in Token**: Token is random, doesn't encode booking ID or user data
6. **Partial Index**: Non-null constraint on index reduces attack surface

---

## Migration Steps

### Apply Migration (Remote Supabase)

```bash
# Push migration to remote database
supabase db push --remote
```

**⚠️ Important**: This project uses **remote-only** Supabase. Do not run migrations locally.

### Verify Migration

```sql
-- Connect to Supabase SQL editor or psql

-- Check columns exist
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_name = 'bookings'
  AND column_name LIKE 'confirmation_%';

-- Expected output:
-- confirmation_token               | character varying | YES
-- confirmation_token_expires_at    | timestamp with time zone | YES
-- confirmation_token_used_at       | timestamp with time zone | YES

-- Check constraint
SELECT constraint_name, constraint_type
FROM information_schema.table_constraints
WHERE table_name = 'bookings'
  AND constraint_name = 'bookings_confirmation_token_unique';

-- Check index
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'bookings'
  AND indexname = 'idx_bookings_confirmation_token';
```

### Rollback (If Needed)

```bash
# Execute rollback script (not supported by Supabase CLI)
# Manual: Run SQL from rollback file in Supabase SQL editor
```

**Rollback SQL**:

```sql
-- See: 20250115071800_add_booking_confirmation_token_rollback.sql
DROP INDEX IF EXISTS public.idx_bookings_confirmation_token;
ALTER TABLE public.bookings DROP CONSTRAINT IF EXISTS bookings_confirmation_token_unique;
ALTER TABLE public.bookings
  DROP COLUMN IF EXISTS confirmation_token,
  DROP COLUMN IF EXISTS confirmation_token_expires_at,
  DROP COLUMN IF EXISTS confirmation_token_used_at;
```

---

## Update TypeScript Types

After applying the migration, regenerate Supabase TypeScript types:

```bash
# Generate types from remote schema
npx supabase gen types typescript --remote > types/supabase.ts
```

**Expected Type Changes**:

```typescript
export interface Database {
  public: {
    Tables: {
      bookings: {
        Row: {
          // ... existing fields
          confirmation_token: string | null;
          confirmation_token_expires_at: string | null;
          confirmation_token_used_at: string | null;
        };
        Insert: {
          // ... existing fields
          confirmation_token?: string | null;
          confirmation_token_expires_at?: string | null;
          confirmation_token_used_at?: string | null;
        };
        Update: {
          // ... existing fields
          confirmation_token?: string | null;
          confirmation_token_expires_at?: string | null;
          confirmation_token_used_at?: string | null;
        };
      };
    };
  };
}
```

---

## Related Code Changes

This migration enables the following code changes (see task plan):

1. **Token Generation**: `server/bookings/confirmation-token.ts`
   - `generateConfirmationToken()` - Generates 64-char token
   - `computeTokenExpiry(hours)` - Calculates expiry timestamp

2. **Token Validation**: `server/bookings/confirmation-token.ts`
   - `validateConfirmationToken(token)` - Checks expiry and usage
   - `markTokenUsed(token)` - Sets `confirmation_token_used_at`

3. **API Changes**:
   - `POST /api/bookings` - Returns `confirmationToken` in response
   - `GET /api/bookings/confirm?token=xxx` - New endpoint (rate-limited)

4. **Frontend Changes**:
   - `/thank-you` page made public (removed from middleware protection)
   - Page fetches booking via token, displays confirmation details

---

## Testing

### Manual Test (After Migration + Code Deployment)

```bash
# 1. Create a booking
curl -X POST http://localhost:3000/api/bookings \
  -H "Content-Type: application/json" \
  -d '{
    "date": "2025-01-20",
    "time": "19:00",
    "party": 4,
    "bookingType": "dinner",
    "seating": "any",
    "name": "Test User",
    "email": "test@example.com",
    "phone": "+1234567890"
  }'

# 2. Extract confirmationToken from response

# 3. Confirm booking
curl http://localhost:3000/api/bookings/confirm?token=<TOKEN>

# 4. Try again (should return 410 - token used)
curl http://localhost:3000/api/bookings/confirm?token=<TOKEN>
```

### Database Checks

```sql
-- View tokens (staging only)
SELECT
  id,
  reference,
  confirmation_token IS NOT NULL as has_token,
  confirmation_token_expires_at,
  confirmation_token_used_at,
  CASE
    WHEN confirmation_token_used_at IS NOT NULL THEN 'USED'
    WHEN confirmation_token_expires_at < NOW() THEN 'EXPIRED'
    ELSE 'VALID'
  END as token_status
FROM public.bookings
WHERE confirmation_token IS NOT NULL
ORDER BY created_at DESC
LIMIT 10;
```

---

## Performance Impact

- **Write Impact**: Negligible (3 additional columns, nullable)
- **Read Impact**: None (columns not queried in existing flows)
- **Index Impact**: Minimal (partial index only on non-null tokens)
- **Storage**: ~100 bytes per booking with token

**Estimated Storage** (1 year, 10k bookings/month):

- 120,000 bookings × 100 bytes = 12 MB (negligible)

---

## Monitoring

After deployment, monitor:

1. **Token Generation Rate**: Should match booking creation rate
2. **Token Expiry Rate**: Tokens not used within 1 hour
3. **Token Replay Attempts**: 410 responses (used tokens)
4. **Rate Limiting**: 429 responses on `/api/bookings/confirm`

**Queries**:

```sql
-- Token usage stats (last 24h)
SELECT
  COUNT(*) FILTER (WHERE confirmation_token IS NOT NULL) as tokens_generated,
  COUNT(*) FILTER (WHERE confirmation_token_used_at IS NOT NULL) as tokens_used,
  COUNT(*) FILTER (WHERE confirmation_token_expires_at < NOW() AND confirmation_token_used_at IS NULL) as tokens_expired
FROM public.bookings
WHERE created_at > NOW() - INTERVAL '24 hours';
```

---

## Rollback Strategy

**Before Rollback**:

1. Verify no active tokens in use (check `confirmation_token_used_at IS NULL`)
2. Notify users: "Confirmation links in recent booking emails will stop working"
3. Revert `/thank-you` page to auth-required

**Rollback Steps**:

1. Deploy code changes (remove token generation/validation)
2. Wait 1 hour (all tokens expired)
3. Run rollback SQL script
4. Verify columns dropped

**Post-Rollback**:

- Guest booking flow reverts to requiring signin
- Existing bookings accessible via email/phone lookup

---

## References

- **Task**: `tasks/route-versioning-auth-cleanup-20251015-0704/`
- **Plan**: `plan.md` (Phase 3)
- **EPIC**: B3 - /thank-you reconciliation
- **Acceptance Criteria**: Guest can complete booking and see confirmation without signin

---

## Sign-off

- [ ] Migration reviewed by: \_\_\_
- [ ] Security approved by: \_\_\_
- [ ] Applied to staging: \_\_\_ (date)
- [ ] Applied to production: \_\_\_ (date)

---

**End of Migration README**
